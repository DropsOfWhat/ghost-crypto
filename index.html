<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>RADAR — DEX Intelligence Terminal</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=Azeret+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<style>
:root {
  --bg-deep: #080b12;
  --bg-primary: #0b0f18;
  --bg-card: #0f1420;
  --bg-card-hover: #141a28;
  --bg-elevated: #151c2b;
  --border-subtle: rgba(255,255,255,0.04);
  --border-default: rgba(255,255,255,0.07);
  --border-active: rgba(255,255,255,0.12);
  --text-primary: #eaf0f6;
  --text-secondary: #8294ab;
  --text-tertiary: #4d6178;
  --text-muted: #344052;
  --accent: #00dba4;
  --accent-dim: rgba(0, 219, 164, 0.12);
  --accent-glow: rgba(0, 219, 164, 0.25);
  --accent-bright: #2fffc2;
  --red: #ff4d6a;
  --red-dim: rgba(255, 77, 106, 0.12);
  --blue: #4da6ff;
  --blue-dim: rgba(77, 166, 255, 0.12);
  --orange: #ffaa33;
  --orange-dim: rgba(255, 170, 51, 0.12);
  --purple: #a78bfa;
  --purple-dim: rgba(167, 139, 250, 0.12);
  --yellow: #ffd166;
  --warm-glow: radial-gradient(ellipse at 20% 0%, rgba(0,219,164,0.06) 0%, transparent 60%),
               radial-gradient(ellipse at 80% 100%, rgba(77,166,255,0.04) 0%, transparent 50%);
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'Azeret Mono', monospace;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-card: 0 2px 8px rgba(0,0,0,0.3), 0 0 1px rgba(255,255,255,0.05);
  --shadow-glow: 0 0 40px rgba(0, 219, 164, 0.08);
  --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 14px; -webkit-font-smoothing: antialiased; }
body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-primary);
  overflow-x: hidden; min-height: 100vh;
  background-image: var(--warm-glow);
  background-attachment: fixed;
  padding-bottom: env(safe-area-inset-bottom);
}
body::before {
  content: ''; position: fixed; top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle at 30% 20%, rgba(0,219,164,0.03) 0%, transparent 40%),
              radial-gradient(circle at 70% 80%, rgba(77,166,255,0.02) 0%, transparent 40%);
  animation: ambientShift 20s ease-in-out infinite alternate;
  pointer-events: none; z-index: 0;
}
@keyframes ambientShift { 0%{transform:translate(0,0) scale(1)} 100%{transform:translate(-3%,-2%) scale(1.05)} }
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:10px}
/* Hide horizontal scrollbar on nav/filters but allow scroll */
.nav::-webkit-scrollbar,.filters::-webkit-scrollbar{height:0;display:none}
.nav,.filters{scrollbar-width:none;-ms-overflow-style:none}

/* ===== HEADER ===== */
.header{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:60px;background:rgba(8,11,18,0.85);backdrop-filter:blur(24px) saturate(1.4);border-bottom:1px solid var(--border-subtle);animation:slideDown .6s ease-out}
@keyframes slideDown{from{transform:translateY(-100%);opacity:0}}
.logo-area{display:flex;align-items:center;gap:14px}
.logo-mark{width:36px;height:36px;position:relative;display:flex;align-items:center;justify-content:center}
.logo-mark .ring{position:absolute;inset:0;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:rgba(0,219,164,0.3);animation:spin 3s linear infinite}
.logo-mark .ring:nth-child(2){inset:4px;border-top-color:var(--blue);border-right-color:rgba(77,166,255,0.2);animation-duration:5s;animation-direction:reverse}
.logo-mark .core{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent-glow);z-index:1}
@keyframes spin{to{transform:rotate(360deg)}}
.logo-text{font-family:var(--font-body);font-weight:800;font-size:1.4rem;letter-spacing:4px;background:linear-gradient(135deg,var(--accent-bright),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-tag{font-family:var(--font-mono);font-size:.6rem;color:var(--accent);border:1px solid var(--accent-dim);padding:2px 8px;border-radius:20px;letter-spacing:1.5px;background:var(--accent-dim)}
.search-wrapper{flex:0 1 480px}
.search-bar{display:flex;align-items:center;gap:10px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:24px;padding:0 18px;height:40px;transition:all .3s ease}
.search-bar:focus-within{border-color:rgba(0,219,164,0.3);box-shadow:0 0 0 3px rgba(0,219,164,0.08),var(--shadow-glow);background:var(--bg-elevated)}
.search-bar svg{flex-shrink:0;opacity:.4;transition:opacity var(--transition)}
.search-bar:focus-within svg{opacity:.7}
.search-bar input{flex:1;background:none;border:none;outline:none;color:var(--text-primary);font-family:var(--font-body);font-size:.9rem}
.search-bar input::placeholder{color:var(--text-tertiary)}
.search-key{font-family:var(--font-mono);font-size:.6rem;color:var(--text-tertiary);border:1px solid var(--border-default);padding:2px 8px;border-radius:6px;background:var(--bg-deep)}

/* Search Dropdown */
.search-dropdown{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--bg-primary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:0 16px 48px rgba(0,0,0,0.5);overflow:hidden;z-index:200;max-height:400px;overflow-y:auto;display:none}
.search-dropdown.active{display:block}
.search-dropdown-header{padding:8px 14px;font-family:var(--font-mono);font-size:.6rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border-subtle);background:rgba(0,0,0,0.2)}
.search-result{display:flex;align-items:center;gap:12px;padding:10px 14px;cursor:pointer;transition:background var(--transition);border-bottom:1px solid var(--border-subtle)}
.search-result:last-child{border:none}
.search-result:hover{background:rgba(255,255,255,0.03)}
.search-result-img{width:32px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border-default);object-fit:cover;flex-shrink:0}
.search-result-fallback{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.65rem;border:1px solid var(--border-default);flex-shrink:0}
.search-result-info{flex:1;min-width:0}
.search-result-name{font-weight:700;font-size:.82rem;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.search-result-sub{font-family:var(--font-mono);font-size:.65rem;color:var(--text-muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.search-result-right{text-align:right;flex-shrink:0}
.search-result-price{font-family:var(--font-mono);font-weight:600;font-size:.8rem;color:var(--text-primary)}
.search-result-chg{font-family:var(--font-mono);font-size:.7rem;font-weight:600;margin-top:1px}
.search-chain-tag{font-size:.55rem;padding:1px 5px;border-radius:4px;font-weight:700;font-family:var(--font-mono);letter-spacing:.3px}
.search-loading{text-align:center;padding:20px;color:var(--text-muted);font-size:.8rem}
.search-empty{text-align:center;padding:20px;color:var(--text-tertiary);font-size:.8rem}
.header-right{display:flex;align-items:center;gap:10px}
.hdr-btn{background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-secondary);padding:8px 16px;border-radius:24px;font-family:var(--font-body);font-size:.8rem;font-weight:500;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:6px}
.hdr-btn:hover{border-color:var(--border-active);color:var(--text-primary);background:var(--bg-card-hover);transform:translateY(-1px)}
.hdr-btn.glow{background:linear-gradient(135deg,var(--accent),#00c9a7);border-color:transparent;color:var(--bg-deep);font-weight:700;box-shadow:0 2px 16px rgba(0,219,164,0.25)}
.hdr-btn.glow:hover{box-shadow:0 4px 24px rgba(0,219,164,0.35);transform:translateY(-2px)}
.notif-dot{width:7px;height:7px;border-radius:50%;background:var(--red);display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.85)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}}

/* ===== TICKER ===== */
.ticker-bar{display:flex;align-items:center;gap:28px;padding:0 24px;height:38px;background:rgba(11,15,24,0.6);border-bottom:1px solid var(--border-subtle);font-family:var(--font-mono);font-size:.72rem;overflow-x:auto}
.ticker-item{display:flex;align-items:center;gap:7px;white-space:nowrap}
.ticker-label{color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.ticker-val{color:var(--text-secondary);font-weight:500}
.ticker-val.up{color:var(--accent)}.ticker-val.down{color:var(--red)}
.ticker-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent-glow);animation:pulse 2s infinite}

/* ===== NAV ===== */
.nav{display:flex;align-items:center;gap:4px;padding:8px 24px;background:rgba(11,15,24,0.4);border-bottom:1px solid var(--border-subtle);overflow-x:auto}
.nav-item{padding:8px 16px;border-radius:24px;font-size:.82rem;font-weight:500;color:var(--text-tertiary);cursor:pointer;transition:all var(--transition);white-space:nowrap;display:flex;align-items:center;gap:7px;border:1px solid transparent}
.nav-item:hover{color:var(--text-secondary);background:rgba(255,255,255,0.03)}
.nav-item.active{color:var(--accent);background:var(--accent-dim);border-color:rgba(0,219,164,0.15);font-weight:600}
.nav-badge{font-family:var(--font-mono);font-size:.55rem;font-weight:700;padding:2px 7px;border-radius:20px;letter-spacing:.5px}
.nav-badge.live{background:var(--red-dim);color:var(--red)}
.nav-badge.ai{background:linear-gradient(135deg,var(--purple-dim),var(--blue-dim));color:var(--purple)}
.nav-sep{width:1px;height:20px;background:var(--border-default);margin:0 6px;flex-shrink:0}

/* ===== FILTERS ===== */
.filters{display:flex;align-items:center;gap:10px;padding:12px 24px;background:rgba(11,15,24,0.3);border-bottom:1px solid var(--border-subtle);flex-wrap:wrap}
.chip-group{display:flex;gap:5px}
.chip{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border-default);color:var(--text-tertiary);transition:all var(--transition);background:transparent}
.chip:hover{border-color:var(--border-active);color:var(--text-secondary);background:rgba(255,255,255,0.02)}
.chip.active{border-color:rgba(0,219,164,0.25);color:var(--accent);background:var(--accent-dim)}
.chip .dot{width:8px;height:8px;border-radius:50%}
.tf-group{display:flex;border:1px solid var(--border-default);border-radius:20px;overflow:hidden}
.tf-btn{padding:5px 12px;font-size:.72rem;font-weight:600;color:var(--text-tertiary);cursor:pointer;border:none;background:none;font-family:var(--font-mono);transition:all var(--transition)}
.tf-btn:hover{color:var(--text-secondary);background:rgba(255,255,255,0.03)}
.tf-btn.active{color:var(--accent);background:var(--accent-dim)}
.ai-shield{margin-left:auto;display:flex;align-items:center;gap:8px;padding:6px 16px;border-radius:20px;font-size:.75rem;font-weight:600;cursor:pointer;background:linear-gradient(135deg,rgba(0,219,164,0.08),rgba(77,166,255,0.06));border:1px solid rgba(0,219,164,0.15);color:var(--accent);transition:all .3s ease}
.ai-shield:hover{border-color:rgba(0,219,164,0.3);box-shadow:0 0 20px rgba(0,219,164,0.08)}

/* ===== LAYOUT ===== */
.main{display:flex;height:calc(100vh - 210px);position:relative;z-index:1}
.content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.sidebar{width:340px;border-left:1px solid var(--border-subtle);background:rgba(11,15,24,0.5);backdrop-filter:blur(12px);overflow-y:auto;animation:slideLeft .6s ease-out .3s backwards}
@keyframes slideLeft{from{transform:translateX(40px);opacity:0}}

/* ===== TABLE ===== */
.table-wrap{flex:1;overflow-y:auto;overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{position:sticky;top:0;z-index:10;padding:12px 14px;text-align:left;font-family:var(--font-mono);font-size:.65rem;font-weight:600;color:var(--text-muted);background:rgba(8,11,18,0.95);backdrop-filter:blur(8px);border-bottom:1px solid var(--border-default);letter-spacing:1px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:color var(--transition)}
thead th:hover{color:var(--text-tertiary)}
tbody tr{border-bottom:1px solid var(--border-subtle);transition:all var(--transition);cursor:pointer;animation:rowIn .4s ease-out backwards}
@keyframes rowIn{from{opacity:0;transform:translateX(-8px)}}
tbody tr:hover{background:rgba(255,255,255,0.025)}
tbody tr:hover td:first-child::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--accent);border-radius:0 2px 2px 0}
td{padding:14px;white-space:nowrap;font-size:.85rem;position:relative}

/* Token cell with image */
.tk{display:flex;align-items:center;gap:12px}
.tk-img{width:36px;height:36px;border-radius:var(--radius-sm);object-fit:cover;border:1px solid var(--border-default);box-shadow:var(--shadow-card);transition:all var(--transition);background:var(--bg-elevated)}
.tk-img-fallback{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.75rem;color:rgba(255,255,255,0.85);border:1px solid var(--border-default);box-shadow:var(--shadow-card);transition:all var(--transition)}
tr:hover .tk-img, tr:hover .tk-img-fallback{border-color:var(--border-active);transform:scale(1.08)}
.tk-name{font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:7px}
.tk-name .chain-dot{width:6px;height:6px;border-radius:3px}
.tk-sub{font-family:var(--font-mono);color:var(--text-muted);font-size:.68rem;margin-top:2px}
.new-tag{font-family:var(--font-mono);font-size:.55rem;font-weight:700;padding:1px 6px;border-radius:4px;background:var(--accent-dim);color:var(--accent);letter-spacing:.5px;animation:pulse 2s infinite}
.verified-badge{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--blue);font-size:8px;color:white;flex-shrink:0}

.rank{font-family:var(--font-mono);font-weight:700;font-size:.8rem;color:var(--text-muted)}
.rank.gold{color:var(--yellow);text-shadow:0 0 8px rgba(255,209,102,0.3)}
.price{font-family:var(--font-mono);font-weight:600}
.chg{font-family:var(--font-mono);font-weight:600;font-size:.82rem}
.chg.up{color:var(--accent)}.chg.down{color:var(--red)}
.muted{font-family:var(--font-mono);color:var(--text-tertiary);font-weight:500}

.ai-score{display:flex;align-items:center;gap:8px}
.ai-bar{width:48px;height:5px;border-radius:10px;background:rgba(255,255,255,0.05);overflow:hidden}
.ai-fill{height:100%;border-radius:10px;transition:width .8s ease}
.ai-fill.high{background:linear-gradient(90deg,var(--accent),var(--accent-bright))}
.ai-fill.mid{background:linear-gradient(90deg,var(--orange),#ffcc66)}
.ai-fill.low{background:linear-gradient(90deg,var(--red),#ff7788)}
.ai-num{font-family:var(--font-mono);font-size:.75rem;font-weight:700}
.ai-num.high{color:var(--accent)}.ai-num.mid{color:var(--orange)}.ai-num.low{color:var(--red)}

.spark{width:88px;height:32px}
.spark svg{width:100%;height:100%}

.safety{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-family:var(--font-mono);font-size:.62rem;font-weight:700;letter-spacing:.3px}
.safety.safe{background:var(--accent-dim);color:var(--accent)}
.safety.warn{background:var(--orange-dim);color:var(--orange)}
.safety.danger{background:var(--red-dim);color:var(--red)}

.qt{display:flex;gap:5px;opacity:0;transition:opacity var(--transition)}
tr:hover .qt{opacity:1}
.qt-btn{padding:5px 12px;border-radius:20px;font-family:var(--font-body);font-size:.7rem;font-weight:700;border:none;cursor:pointer;transition:all var(--transition)}
.qt-buy{background:var(--accent-dim);color:var(--accent)}.qt-buy:hover{background:var(--accent);color:var(--bg-deep);box-shadow:0 0 16px var(--accent-glow)}
.qt-sell{background:var(--red-dim);color:var(--red)}.qt-sell:hover{background:var(--red);color:white}

/* ===== SIDEBAR ===== */
.sb-section{padding:20px;border-bottom:1px solid var(--border-subtle)}
.sb-title{font-weight:700;font-size:.85rem;color:var(--text-primary);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.sb-title .ico{font-size:1.05rem}

.insight{border-radius:var(--radius-md);padding:14px;margin-bottom:10px;border:1px solid;transition:all var(--transition);position:relative;overflow:hidden}
.insight::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;opacity:.03;background:radial-gradient(circle at 0% 0%,currentColor,transparent 70%)}
.insight:hover{transform:translateY(-1px)}
.insight.trend{background:rgba(0,219,164,0.04);border-color:rgba(0,219,164,0.12);color:var(--accent)}
.insight.whale{background:rgba(77,166,255,0.04);border-color:rgba(77,166,255,0.12);color:var(--blue)}
.insight.warning{background:rgba(255,77,106,0.04);border-color:rgba(255,77,106,0.12);color:var(--red)}
.insight-head{font-family:var(--font-mono);font-size:.65rem;font-weight:700;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.insight-body{font-size:.8rem;line-height:1.55;color:var(--text-secondary);position:relative;z-index:1}
.insight-body strong{color:var(--accent);font-weight:600}
.insight-body .red-hl{color:var(--red);font-weight:600}

.heatmap{display:grid;grid-template-columns:repeat(4,1fr);gap:5px}
.heat{aspect-ratio:1;border-radius:var(--radius-sm);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition);overflow:hidden}
.heat:hover{transform:scale(1.08);z-index:1;box-shadow:0 4px 16px rgba(0,0,0,0.4)}
.heat .h-name{font-family:var(--font-mono);font-size:.58rem;font-weight:600;color:rgba(255,255,255,0.85);margin-bottom:2px}
.heat .h-val{font-family:var(--font-mono);font-size:.72rem;font-weight:800;color:white}

.wallet-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-subtle);transition:all var(--transition)}
.wallet-row:last-child{border:none}
.wallet-row:hover{padding-left:4px}
.wallet-avi{width:32px;height:32px;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));border:1px solid var(--border-default);display:flex;align-items:center;justify-content:center;font-size:.85rem}
.wallet-info{flex:1}
.wallet-addr{font-family:var(--font-mono);font-size:.75rem;font-weight:600;color:var(--text-primary)}
.wallet-act{font-size:.68rem;margin-top:2px;font-weight:500}
.wallet-act.buy{color:var(--accent)}.wallet-act.sell{color:var(--red)}
.wallet-pnl{font-family:var(--font-mono);font-size:.78rem;font-weight:700}
.wallet-pnl.up{color:var(--accent)}.wallet-pnl.down{color:var(--red)}

.feed{max-height:220px;overflow-y:auto}
.feed-row{display:flex;align-items:center;gap:8px;padding:7px 0;font-size:.75rem;border-bottom:1px solid var(--border-subtle);animation:feedIn .35s ease-out}
@keyframes feedIn{from{opacity:0;transform:translateX(-10px)}}
.feed-time{font-family:var(--font-mono);font-size:.62rem;color:var(--text-muted);width:40px;flex-shrink:0}
.feed-type{font-weight:700;font-size:.7rem}.feed-type.buy{color:var(--accent)}.feed-type.sell{color:var(--red)}
.feed-tok{font-weight:600;color:var(--text-primary)}
.feed-amt{margin-left:auto;font-family:var(--font-mono);color:var(--text-tertiary);font-weight:500}

/* ===== MODAL ===== */
.overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.75);backdrop-filter:blur(16px);display:none;align-items:center;justify-content:center}
.overlay.active{display:flex}
.modal{width:94vw;max-width:1260px;height:88vh;background:var(--bg-primary);border:1px solid var(--border-default);border-radius:var(--radius-xl);overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.6),0 0 1px rgba(255,255,255,0.1);animation:modalIn .35s cubic-bezier(0.16,1,0.3,1)}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(20px)}}

/* Modal Header with Banner */
.modal-banner{height:120px;position:relative;overflow:hidden;border-bottom:1px solid var(--border-subtle)}
.modal-banner-bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(0.5) saturate(1.3)}
.modal-banner-overlay{position:absolute;inset:0;background:linear-gradient(to top,var(--bg-primary),transparent 60%)}
.unclaimed-banner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg-card),var(--bg-elevated))}
.unclaimed-banner-text{font-size:.8rem;color:var(--text-muted);display:flex;align-items:center;gap:8px}
.claim-banner-btn{padding:6px 16px;border-radius:20px;background:var(--accent-dim);border:1px solid rgba(0,219,164,0.2);color:var(--accent);font-size:.75rem;font-weight:600;cursor:pointer;transition:all var(--transition);font-family:var(--font-body)}
.claim-banner-btn:hover{background:var(--accent);color:var(--bg-deep);box-shadow:0 0 16px var(--accent-glow)}

.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;position:relative;z-index:2;margin-top:-44px}
.modal-tk{display:flex;align-items:center;gap:14px}
.modal-icon{width:56px;height:56px;border-radius:var(--radius-md);object-fit:cover;border:3px solid var(--bg-primary);box-shadow:var(--shadow-card);background:var(--bg-elevated)}
.modal-icon-fallback{width:56px;height:56px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800;border:3px solid var(--bg-primary);box-shadow:var(--shadow-card)}
.modal-name{font-weight:700;font-size:1.25rem;display:flex;align-items:center;gap:8px}
.modal-pair{font-family:var(--font-mono);color:var(--text-muted);font-size:.75rem;margin-top:2px}
.modal-price-wrap{margin-left:24px}
.modal-price{font-family:var(--font-mono);font-size:1.5rem;font-weight:700}
.modal-chg{font-family:var(--font-mono);font-size:.9rem;font-weight:600;margin-left:10px}
.modal-chg.up{color:var(--accent)}.modal-chg.down{color:var(--red)}
.close-btn{background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-tertiary);width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all var(--transition);position:relative;z-index:2;margin-top:44px}
.close-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}

/* Social Links Bar */
.social-bar{display:flex;align-items:center;gap:8px;padding:10px 24px;border-bottom:1px solid var(--border-subtle);flex-wrap:wrap}
.social-link{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:.72rem;font-weight:500;color:var(--text-tertiary);border:1px solid var(--border-default);transition:all var(--transition);text-decoration:none;cursor:pointer}
.social-link:hover{color:var(--text-primary);border-color:var(--border-active);background:rgba(255,255,255,0.03)}
.social-link.empty{border-style:dashed;opacity:.5}
.social-link.empty:hover{opacity:.8;border-color:var(--accent);color:var(--accent)}
.social-sep{flex:1}
.claim-profile-btn{display:flex;align-items:center;gap:6px;padding:6px 18px;border-radius:20px;font-size:.78rem;font-weight:700;cursor:pointer;background:linear-gradient(135deg,rgba(167,139,250,0.1),rgba(77,166,255,0.08));border:1px solid rgba(167,139,250,0.2);color:var(--purple);transition:all .3s ease;font-family:var(--font-body)}
.claim-profile-btn:hover{border-color:var(--purple);box-shadow:0 0 20px var(--purple-dim);transform:translateY(-1px)}

.modal-content{flex:1;display:flex;overflow:hidden}
.modal-chart{flex:1;padding:24px;display:flex;flex-direction:column}
.chart-area{flex:1;border-radius:var(--radius-lg);background:#0f1420;border:1px solid var(--border-subtle);overflow:hidden;position:relative;min-height:400px}
.chart-area iframe{width:100%!important;height:100%!important;border:none!important;border-radius:var(--radius-lg)}
.chart-loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text-muted);font-size:.85rem;z-index:2;background:#0f1420}
.chart-loading .spinner{width:28px;height:28px;border-radius:50%;border:3px solid var(--border-default);border-top-color:var(--accent);animation:spin 1s linear infinite}

.modal-side{width:370px;border-left:1px solid var(--border-subtle);overflow-y:auto;padding:20px;background:rgba(255,255,255,0.01)}

/* Trade Panel */
.trade-box{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:18px;margin-bottom:16px}
.trade-tabs{display:flex;gap:5px;margin-bottom:16px}
.t-tab{flex:1;padding:10px;text-align:center;border-radius:var(--radius-sm);font-size:.85rem;font-weight:700;cursor:pointer;border:1px solid var(--border-default);color:var(--text-tertiary);transition:all var(--transition)}
.t-tab.buy-active{background:var(--accent-dim);border-color:rgba(0,219,164,0.2);color:var(--accent)}
.t-tab.sell-active{background:var(--red-dim);border-color:rgba(255,77,106,0.2);color:var(--red)}
.presets{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:14px}
.preset{padding:8px;text-align:center;border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:.72rem;font-weight:600;cursor:pointer;background:rgba(255,255,255,0.03);border:1px solid var(--border-default);color:var(--text-tertiary);transition:all var(--transition)}
.preset:hover{border-color:rgba(0,219,164,0.2);color:var(--accent);background:var(--accent-dim)}
.input-group{margin-bottom:12px}
.input-label{font-family:var(--font-mono);font-size:.65rem;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.trade-input{width:100%;padding:12px 16px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-deep);color:var(--text-primary);font-family:var(--font-mono);font-size:1rem;font-weight:600;outline:none;transition:all var(--transition)}
.trade-input:focus{border-color:rgba(0,219,164,0.3);box-shadow:0 0 0 3px rgba(0,219,164,0.06)}
.exec-btn{width:100%;padding:14px;border-radius:var(--radius-sm);border:none;font-family:var(--font-body);font-size:.95rem;font-weight:800;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:8px}
.exec-btn.buy{background:linear-gradient(135deg,var(--accent),#00c9a7);color:var(--bg-deep);box-shadow:0 4px 20px rgba(0,219,164,0.2)}
.exec-btn.buy:hover{box-shadow:0 6px 30px rgba(0,219,164,0.35);transform:translateY(-1px)}

/* AI Analysis */
.ai-box{border-radius:var(--radius-lg);padding:18px;background:linear-gradient(135deg,rgba(167,139,250,0.04),rgba(77,166,255,0.03));border:1px solid rgba(167,139,250,0.1);margin-bottom:16px}
.ai-box-title{font-weight:800;font-size:.85rem;background:linear-gradient(135deg,var(--purple),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.ai-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
.ai-row:last-child{border:none}
.ai-row-label{font-size:.76rem;color:var(--text-tertiary)}
.ai-row-val{font-family:var(--font-mono);font-size:.76rem;font-weight:700}
.dist{margin-top:14px}
.dist-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.dist-label{font-family:var(--font-mono);font-size:.65rem;color:var(--text-muted);width:48px}
.dist-bar{flex:1;height:6px;border-radius:10px;background:rgba(255,255,255,0.04);overflow:hidden}
.dist-fill{height:100%;border-radius:10px;transition:width 1.2s ease}
.dist-pct{font-family:var(--font-mono);font-size:.65rem;color:var(--text-tertiary);width:30px;text-align:right}

/* ===== CLAIM PROFILE MODAL ===== */
.claim-overlay{position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center}
.claim-overlay.active{display:flex}
.claim-modal{width:680px;max-width:95vw;max-height:90vh;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-default);border-radius:var(--radius-xl);padding:0;box-shadow:0 24px 80px rgba(0,0,0,0.6);animation:modalIn .35s cubic-bezier(0.16,1,0.3,1)}

.claim-header{padding:28px 28px 20px;border-bottom:1px solid var(--border-subtle)}
.claim-title{font-size:1.4rem;font-weight:800;margin-bottom:4px}
.claim-subtitle{color:var(--text-tertiary);font-size:.88rem;line-height:1.5}

/* Pricing Cards */
.pricing-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:24px 28px}
.pricing-card{border-radius:var(--radius-lg);padding:20px;border:1px solid var(--border-default);background:var(--bg-card);transition:all .3s ease;cursor:pointer;position:relative;overflow:hidden}
.pricing-card:hover{transform:translateY(-4px);border-color:var(--border-active)}
.pricing-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0}
.pricing-card.free::before{background:var(--accent)}
.pricing-card.pro::before{background:linear-gradient(90deg,var(--blue),var(--purple))}
.pricing-card.boost::before{background:linear-gradient(90deg,var(--yellow),var(--orange))}
.pricing-card.popular{border-color:rgba(77,166,255,0.25)}
.pricing-card.popular:hover{border-color:var(--blue);box-shadow:0 0 30px var(--blue-dim)}
.popular-tag{position:absolute;top:12px;right:12px;font-family:var(--font-mono);font-size:.55rem;font-weight:700;padding:2px 8px;border-radius:20px;background:var(--blue-dim);color:var(--blue);letter-spacing:.5px}
.card-name{font-weight:800;font-size:1rem;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.card-price{font-family:var(--font-mono);font-weight:800;margin-bottom:2px}
.card-price .amount{font-size:1.6rem}
.card-price .period{font-size:.7rem;color:var(--text-tertiary);font-weight:500}
.card-price .free-label{font-size:1.6rem;color:var(--accent)}
.card-desc{font-size:.78rem;color:var(--text-tertiary);margin-bottom:16px;line-height:1.4;min-height:40px}
.card-features{list-style:none;margin-bottom:18px}
.card-features li{display:flex;align-items:flex-start;gap:8px;font-size:.78rem;color:var(--text-secondary);padding:4px 0}
.card-features li .check{color:var(--accent);font-weight:700;flex-shrink:0}
.card-features li .x-mark{color:var(--text-muted);flex-shrink:0}
.card-btn{width:100%;padding:12px;border-radius:var(--radius-sm);border:none;font-family:var(--font-body);font-size:.85rem;font-weight:700;cursor:pointer;transition:all var(--transition);text-align:center}
.card-btn.free-btn{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,219,164,0.15)}
.card-btn.free-btn:hover{background:var(--accent);color:var(--bg-deep)}
.card-btn.pro-btn{background:linear-gradient(135deg,var(--blue),var(--purple));color:white;box-shadow:0 2px 16px rgba(77,166,255,0.2)}
.card-btn.pro-btn:hover{box-shadow:0 4px 24px rgba(77,166,255,0.35);transform:translateY(-1px)}
.card-btn.boost-btn{background:linear-gradient(135deg,var(--yellow),var(--orange));color:var(--bg-deep);box-shadow:0 2px 16px rgba(255,170,51,0.2)}
.card-btn.boost-btn:hover{box-shadow:0 4px 24px rgba(255,170,51,0.35);transform:translateY(-1px)}

/* Community fund section */
.community-section{padding:20px 28px 28px;border-top:1px solid var(--border-subtle);margin-top:4px}
.community-card{border-radius:var(--radius-lg);padding:20px;background:linear-gradient(135deg,rgba(0,219,164,0.04),rgba(77,166,255,0.03));border:1px solid rgba(0,219,164,0.12)}
.community-title{font-weight:800;font-size:.95rem;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.community-desc{font-size:.8rem;color:var(--text-secondary);line-height:1.5;margin-bottom:14px}
.fund-progress{margin-bottom:10px}
.fund-bar-bg{height:10px;border-radius:10px;background:rgba(255,255,255,0.05);overflow:hidden;margin-bottom:6px}
.fund-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--blue));transition:width 1.5s ease}
.fund-stats{display:flex;justify-content:space-between;font-family:var(--font-mono);font-size:.68rem}
.fund-raised{color:var(--accent);font-weight:600}
.fund-goal{color:var(--text-muted)}
.fund-contributors{display:flex;align-items:center;gap:4px;margin-top:10px}
.fund-avi{width:24px;height:24px;border-radius:50%;border:2px solid var(--bg-primary);margin-left:-8px;font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
.fund-avi:first-child{margin-left:0}
.fund-count{font-family:var(--font-mono);font-size:.7rem;color:var(--text-tertiary);margin-left:8px}
.contribute-btn{margin-top:14px;padding:10px 20px;border-radius:var(--radius-sm);border:1px solid rgba(0,219,164,0.2);background:var(--accent-dim);color:var(--accent);font-family:var(--font-body);font-size:.82rem;font-weight:700;cursor:pointer;transition:all var(--transition)}
.contribute-btn:hover{background:var(--accent);color:var(--bg-deep);box-shadow:0 0 16px var(--accent-glow)}

.claim-close{position:absolute;top:20px;right:20px;background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-tertiary);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all var(--transition);z-index:1}
.claim-close:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}

/* Payment confirmation overlay inside card */
.payment-confirm{padding:20px;text-align:center}
.payment-confirm-title{font-size:1rem;font-weight:800;margin-bottom:6px;color:var(--text-primary)}
.payment-confirm-sub{font-size:.78rem;color:var(--text-tertiary);margin-bottom:16px;line-height:1.5}
.payment-sol-amount{font-family:var(--font-mono);font-size:1.8rem;font-weight:800;color:var(--accent);margin-bottom:4px}
.payment-usd-equiv{font-family:var(--font-mono);font-size:.8rem;color:var(--text-muted);margin-bottom:20px}
.payment-detail{display:flex;justify-content:space-between;padding:8px 0;font-size:.78rem;border-bottom:1px solid var(--border-subtle)}
.payment-detail-label{color:var(--text-tertiary)}
.payment-detail-val{font-family:var(--font-mono);color:var(--text-primary);font-weight:600}
.payment-detail-val.addr{font-size:.65rem;word-break:break-all}
.payment-actions{display:flex;gap:8px;margin-top:20px}
.payment-actions button{flex:1;padding:12px;border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.85rem;font-weight:700;cursor:pointer;border:none;transition:all var(--transition)}
.payment-actions .pay-btn{background:linear-gradient(135deg,var(--accent),#00c9a7);color:var(--bg-deep);box-shadow:0 4px 20px rgba(0,219,164,0.2)}
.payment-actions .pay-btn:hover{box-shadow:0 6px 30px rgba(0,219,164,0.35);transform:translateY(-1px)}
.payment-actions .cancel-btn{background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-tertiary)}
.payment-actions .cancel-btn:hover{border-color:var(--red);color:var(--red)}
.payment-status{text-align:center;padding:30px 20px}
.payment-status .spinner-lg{width:40px;height:40px;border-radius:50%;border:3px solid var(--border-default);border-top-color:var(--accent);animation:spin 1s linear infinite;margin:0 auto 16px}
.payment-success{font-size:2rem;margin-bottom:12px}
.payment-tx{font-family:var(--font-mono);font-size:.65rem;color:var(--text-muted);word-break:break-all;margin-top:8px}
.payment-tx a{color:var(--accent);text-decoration:none}
.payment-tx a:hover{text-decoration:underline}
.claim-form{padding:20px}
.claim-form-group{margin-bottom:14px}
.claim-form-label{font-size:.72rem;font-weight:600;color:var(--text-muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;font-family:var(--font-mono)}
.claim-form-input{width:100%;padding:10px 14px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-deep);color:var(--text-primary);font-family:var(--font-body);font-size:.85rem;outline:none;transition:border var(--transition);box-sizing:border-box}
.claim-form-input:focus{border-color:rgba(0,219,164,0.3);box-shadow:0 0 0 3px rgba(0,219,164,0.06)}
.claim-form-input::placeholder{color:var(--text-tertiary)}
textarea.claim-form-input{resize:vertical;min-height:60px;font-family:var(--font-body)}
.claim-form-submit{width:100%;padding:12px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--accent),#00c9a7);color:var(--bg-deep);font-family:var(--font-body);font-size:.9rem;font-weight:800;cursor:pointer;transition:all var(--transition);margin-top:6px}
.claim-form-submit:hover{box-shadow:0 6px 30px rgba(0,219,164,0.35);transform:translateY(-1px)}
.contribute-input-wrap{display:flex;gap:8px;margin-bottom:16px}
.contribute-input-wrap input{flex:1}
.contribute-input-wrap .sol-equiv{font-family:var(--font-mono);font-size:.75rem;color:var(--text-muted);display:flex;align-items:center;padding:0 8px;white-space:nowrap}

/* Comparison to DS */
.comparison{padding:0 28px 24px}
.comparison-note{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--radius-md);background:rgba(255,209,102,0.05);border:1px solid rgba(255,209,102,0.12);font-size:.78rem;color:var(--text-secondary);line-height:1.4}
.comparison-note strong{color:var(--yellow)}


/* ============================================
   RESPONSIVE DESIGN
   ============================================ */

/* Copy-trade grid base */
.copytrade-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:16px}

/* ---- Desktop sidebar ---- */
@media(max-width:1200px){.sidebar{width:300px}}

/* ---- Tablet ≤ 960px ---- */
@media(max-width:960px){
  .sidebar{display:none}
  .search-wrapper{flex:0 1 300px}
  .modal-content{flex-direction:column}
  .modal-side{width:100%;border-left:none;border-top:1px solid var(--border-subtle);max-height:50vh}
  .chart-area{min-height:300px}
  .modal{height:95vh;width:98vw}
  .copytrade-grid{grid-template-columns:1fr}
  .pricing-cards{grid-template-columns:1fr}
}

/* ---- Small tablet / landscape phone ≤ 768px ---- */
@media(max-width:768px){
  /* Header */
  .header{padding:0 12px;height:52px;gap:6px}
  .logo-text{font-size:1.1rem;letter-spacing:2px}
  .logo-tag{display:none}
  .search-wrapper{flex:0 1 180px}
  .search-bar{height:36px;padding:0 12px}
  .search-bar input{font-size:.8rem}
  .search-key{display:none}
  .header-right{gap:6px}
  .hdr-btn{padding:6px 10px;font-size:.72rem;gap:4px}

  /* Ticker */
  .ticker-bar{gap:14px;padding:0 12px;height:32px;font-size:.65rem}

  /* Nav — scroll */
  .nav{padding:6px 12px;gap:3px;-webkit-overflow-scrolling:touch}
  .nav-item{padding:6px 12px;font-size:.75rem;gap:5px;flex-shrink:0}
  .nav-badge{font-size:.5rem;padding:1px 5px}

  /* Filters — scroll */
  .filters{padding:8px 12px;gap:6px;overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch}
  .chip{flex-shrink:0;font-size:.68rem;padding:5px 10px}
  .chip-group{flex-shrink:0;flex-wrap:nowrap}
  .tf-btn{padding:4px 10px;font-size:.65rem}
  .ai-shield{font-size:.65rem;padding:6px 10px;flex-shrink:0}

  /* Main */
  .main{height:calc(100vh - 180px)}
  table{font-size:.78rem}
  thead th{padding:8px 6px;font-size:.58rem}
  td{padding:10px 6px;font-size:.78rem}
  .tk-img,.tk-img-fallback{width:30px!important;height:30px!important}
  .tk-name{font-size:.8rem}
  .tk-sub{font-size:.6rem}
  .spark{width:60px;height:24px}

  /* Modal */
  .modal-banner{height:80px}
  .modal-head{padding:12px 16px;margin-top:-36px}
  .modal-icon,.modal-icon-fallback{width:44px!important;height:44px!important}
  .modal-name{font-size:1rem}
  .modal-price{font-size:1.1rem}
  .modal-chg{font-size:.8rem}
  .modal-price-wrap{margin-left:14px}
  .close-btn{width:34px;height:34px;font-size:.9rem;margin-top:36px}
  .social-bar{padding:8px 12px;gap:6px}
  .modal-chart{padding:12px}
  .modal-side{padding:14px}

  /* Charts grid → 1 column */
  .view-grid.charts-2x3,.view-grid.charts-2x2{grid-template-columns:1fr}
  .chart-cell{min-height:220px}

  /* Trader stats */
  .trader-stats{grid-template-columns:1fr 1fr;gap:6px}

  /* Panels → bottom sheet */
  .panel-overlay{padding:0;align-items:flex-end}
  .panel{width:100%;max-width:100vw;border-radius:16px 16px 0 0;max-height:85vh}

  /* View headers */
  .view-header{padding:10px 12px;flex-direction:column;align-items:flex-start;gap:6px}
  .view-header-title{font-size:.9rem}
  .view-header-sub{font-size:.68rem}
}

/* ---- Phone ≤ 480px ---- */
@media(max-width:480px){
  /* Header compact */
  .header{padding:0 8px;height:48px}
  .logo-mark{width:28px;height:28px}
  .logo-text{font-size:.95rem;letter-spacing:1px}
  .search-wrapper{display:none}
  .header-right{gap:4px}
  .hdr-btn{padding:5px 8px;font-size:.62rem;border-radius:18px;gap:3px}
  /* Hide button text labels, keep emoji + badges */
  .btn-label{display:none}

  /* Ticker minimal */
  .ticker-bar{gap:8px;padding:0 8px;height:28px;font-size:.58rem}
  .ticker-label{display:none}
  .ticker-dot{width:4px;height:4px}

  /* Nav scroll strip */
  .nav{padding:4px 8px;gap:2px}
  .nav-item{padding:5px 9px;font-size:.68rem;gap:3px;flex-shrink:0}
  .nav-sep{margin:0 2px;height:16px}

  /* Filters scroll strip */
  .filters{padding:4px 8px;gap:4px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .chip{font-size:.6rem;padding:4px 8px;flex-shrink:0}
  .tf-group{flex-shrink:0}
  .tf-btn{padding:3px 8px;font-size:.6rem}
  .ai-shield{font-size:.58rem;padding:4px 8px;gap:3px;flex-shrink:0}

  .main{height:calc(100vh - 155px)}

  /* Table — hide non-essential columns
     Keep: #, Token, Price, 24H, Volume, Actions */
  thead th:nth-child(4),td:nth-child(4),
  thead th:nth-child(5),td:nth-child(5),
  thead th:nth-child(6),td:nth-child(6),
  thead th:nth-child(7),td:nth-child(7),
  thead th:nth-child(8),td:nth-child(8),
  thead th:nth-child(11),td:nth-child(11),
  thead th:nth-child(12),td:nth-child(12),
  thead th:nth-child(13),td:nth-child(13)
  {display:none}

  td{padding:8px 5px;font-size:.74rem}
  thead th{padding:6px 5px;font-size:.52rem;letter-spacing:.3px}
  .tk{gap:8px}
  .tk-img,.tk-img-fallback{width:26px!important;height:26px!important;font-size:.55rem!important;border-radius:6px!important}
  .tk-name{font-size:.74rem;gap:4px}
  .chain-dot{width:4px!important;height:4px!important}
  .new-tag{font-size:.48rem;padding:1px 4px}
  .verified-badge{width:11px;height:11px;font-size:6px}
  .tk-sub{font-size:.52rem}
  .rank{font-size:.68rem}
  .price{font-size:.72rem}
  .chg{font-size:.68rem}
  .muted{font-size:.68rem}
  .qt-btn{padding:3px 7px;font-size:.58rem}
  .star-btn{font-size:.85rem;padding:2px}

  /* Modal fullscreen */
  .overlay{padding:0}
  .overlay.active{align-items:stretch}
  .modal{width:100vw;height:100vh;max-width:100vw;border-radius:0;border:none}
  .modal-content{flex-direction:column;overflow-y:auto}
  .modal-side{width:100%;border-left:none;border-top:1px solid var(--border-subtle);max-height:none;overflow:visible}
  .modal-chart{padding:8px}
  .chart-area{min-height:240px}
  .modal-banner{height:60px}
  .modal-head{padding:8px 12px;margin-top:-30px;gap:8px;flex-wrap:wrap}
  .modal-tk{gap:10px;flex-wrap:wrap}
  .modal-icon,.modal-icon-fallback{width:36px!important;height:36px!important;font-size:1rem!important;border-width:2px!important}
  .modal-name{font-size:.88rem;gap:4px}
  .modal-pair{font-size:.62rem}
  .modal-price-wrap{margin-left:0;margin-top:4px;width:100%}
  .modal-price{font-size:1.15rem}
  .modal-chg{font-size:.75rem;margin-left:8px}
  .close-btn{width:30px;height:30px;font-size:.8rem;margin-top:30px;position:absolute;right:10px;top:-20px}
  .social-bar{padding:6px 10px;gap:4px;flex-wrap:wrap}
  .social-link{padding:3px 8px;font-size:.6rem}
  .claim-profile-btn{padding:4px 10px;font-size:.62rem}

  /* Trade panel */
  .trade-box{padding:12px}
  .t-tab{padding:8px;font-size:.74rem}
  .presets{gap:4px}
  .preset{padding:6px;font-size:.62rem}
  .trade-input{padding:10px 12px;font-size:.88rem}
  .exec-btn{padding:12px;font-size:.82rem}
  .ai-box{padding:12px}
  .ai-box-title{font-size:.78rem}
  .ai-row{padding:6px 0}
  .ai-row-label,.ai-row-val{font-size:.68rem}
  .dist-label{font-size:.58rem;width:38px}

  /* Panels bottom sheet */
  .panel-overlay{padding:0;align-items:flex-end}
  .panel{width:100%;max-width:100%;border-radius:16px 16px 0 0;max-height:90vh}
  .panel-header{padding:14px 16px}
  .panel-body{padding:12px 14px}
  .wallet-option{padding:12px;gap:10px}
  .wallet-option img{width:32px;height:32px}
  .wallet-info-card{padding:12px}
  .wallet-addr-full{font-size:.65rem;word-break:break-all}
  .wallet-balance{font-size:1.4rem}
  .portfolio-token{padding:10px;gap:8px}
  .portfolio-total-val{font-size:1.15rem}
  .alert-form{padding:10px}
  .alert-form-row select,.alert-form-row input{padding:8px 10px;font-size:.72rem}
  .alert-item{padding:10px;gap:6px}

  /* Claim modal */
  .claim-modal{max-width:100vw;width:100vw;border-radius:16px 16px 0 0;max-height:95vh}
  .claim-header{padding:20px 14px}
  .claim-title{font-size:1.05rem}
  .pricing-cards{gap:8px;padding:0 14px}
  .pricing-card{padding:14px}
  .card-price .amount{font-size:1.4rem}
  .comparison{padding:10px 14px}
  .community-section{padding:0 14px 14px}

  /* Card views */
  .data-card{padding:12px}
  .data-card-row{gap:10px}
  .data-card-icon{width:36px;height:36px;font-size:1.1rem}
  .data-card-title{font-size:.8rem}
  .data-card-sub{font-size:.65rem}
  .whale-amount{font-size:.82rem}
  .data-card-tag{font-size:.55rem;padding:2px 5px}
  .data-card-val{font-size:.82rem}
  .data-card-meta{font-size:.6rem}

  /* Scanner */
  .scanner-metrics{gap:4px}
  .scanner-metric{padding:6px 4px}
  .scanner-metric-val{font-size:.72rem}
  .scanner-metric-label{font-size:.48rem}

  /* Copy trade */
  .copytrade-grid{grid-template-columns:1fr!important;gap:10px;padding:12px}
  .trader-card{padding:12px}
  .trader-header{gap:10px;margin-bottom:10px}
  .trader-avi{width:38px;height:38px;font-size:1rem}
  .trader-name{font-size:.82rem}
  .trader-addr{font-size:.6rem}
  .trader-stats{grid-template-columns:1fr 1fr;gap:4px}
  .trader-stat{padding:6px 4px}
  .trader-stat-val{font-size:.72rem}
  .trader-stat-label{font-size:.48rem}
  .trader-trade{font-size:.58rem;padding:3px 5px}
  .copy-btn{padding:8px;font-size:.72rem;margin-top:10px}

  /* Multicharts */
  .view-grid{padding:8px;gap:8px}
  .chart-cell{min-height:200px}
  .chart-cell-header{padding:6px 10px}
  .chart-cell-token{font-size:.72rem;gap:4px}

  /* Watchlist */
  .watchlist-empty{padding:40px 16px}
  .watchlist-empty-icon{font-size:2.4rem}
}

/* ---- Tiny phone ≤ 360px ---- */
@media(max-width:360px){
  .header{padding:0 6px;height:44px}
  .logo-mark{width:24px;height:24px}
  .logo-text{font-size:.82rem;letter-spacing:0}
  .header-right{gap:3px}
  .hdr-btn{padding:4px 6px;font-size:.56rem}
  .nav-item{padding:4px 7px;font-size:.6rem}
  td{padding:6px 3px;font-size:.68rem}
  .tk-img,.tk-img-fallback{width:22px!important;height:22px!important}
  .tk-name{font-size:.68rem}
  .tk-sub{font-size:.48rem}
  .modal-price{font-size:1rem}
  .modal-name{font-size:.8rem}
}

/* ---- Touch targets ---- */
@media(hover:none) and (pointer:coarse){
  .nav-item{min-height:36px;display:flex;align-items:center}
  .chip{min-height:32px;display:flex;align-items:center}
  .tf-btn{min-height:32px}
  .hdr-btn{min-height:36px}
  tbody tr{min-height:48px}
  .qt-btn{min-height:32px;min-width:42px}
  .star-btn{min-width:34px;min-height:34px;display:flex;align-items:center;justify-content:center}
  .data-card{min-height:56px}
  .wallet-option{min-height:52px}
  .preset{min-height:36px}
  .exec-btn{min-height:48px}
  .social-link{min-height:32px}
  .close-btn{min-width:38px;min-height:38px}
  .copy-btn{min-height:44px}
  .alert-add-btn{min-height:44px}
  .view-header-btn{min-height:34px}
}
/* ============ WALLET / PORTFOLIO / ALERTS ============ */
.alert-count{background:var(--red);color:white;font-size:.65rem;font-weight:700;padding:1px 6px;border-radius:10px;margin-left:4px}

/* ============ VIEW LAYOUTS ============ */
.view-grid{display:grid;gap:12px;padding:16px;overflow-y:auto;flex:1}
.view-grid.charts-2x3{grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr}
.view-grid.charts-2x2{grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr}
.chart-cell{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);overflow:hidden;position:relative;min-height:260px}
.chart-cell-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border-subtle);background:rgba(0,0,0,0.2)}
.chart-cell-token{display:flex;align-items:center;gap:8px;font-weight:700;font-size:.85rem;color:var(--text-primary)}
.chart-cell-chg{font-family:var(--font-mono);font-size:.8rem;font-weight:600}
.chart-cell-close{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.8rem;padding:2px 6px;border-radius:4px}
.chart-cell-close:hover{color:var(--red);background:var(--red-dim)}
.chart-cell iframe{width:100%;height:calc(100% - 42px);border:none}

/* Whale/Scanner/Copytrade card view */
.card-view{display:flex;flex-direction:column;gap:10px;padding:16px;overflow-y:auto;flex:1}
.data-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:16px;transition:all var(--transition);cursor:pointer}
.data-card:hover{border-color:var(--border-active);background:var(--bg-card-hover);transform:translateY(-1px)}
.data-card-row{display:flex;align-items:center;gap:14px}
.data-card-icon{width:44px;height:44px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0}
.data-card-info{flex:1;min-width:0}
.data-card-title{font-weight:700;font-size:.9rem;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.data-card-sub{font-size:.75rem;color:var(--text-tertiary);margin-top:2px;font-family:var(--font-mono)}
.data-card-right{text-align:right;flex-shrink:0}
.data-card-val{font-family:var(--font-mono);font-weight:700;font-size:.95rem}
.data-card-meta{font-size:.7rem;color:var(--text-muted);margin-top:2px}
.data-card-tags{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.data-card-tag{font-size:.65rem;padding:3px 8px;border-radius:6px;font-weight:600;font-family:var(--font-mono)}
.data-card-tag.buy{background:var(--accent-dim);color:var(--accent)}
.data-card-tag.sell{background:var(--red-dim);color:var(--red)}
.data-card-tag.info{background:rgba(77,166,255,0.1);color:var(--blue)}
.data-card-tag.warn{background:rgba(255,170,51,0.1);color:var(--orange)}
.data-card-tag.new{background:var(--accent-dim);color:var(--accent)}

/* Whale amounts */
.whale-amount{font-family:var(--font-mono);font-weight:800;font-size:1rem}
.whale-amount.buy{color:var(--accent)}
.whale-amount.sell{color:var(--red)}

/* AI Scanner expanded rows */
.scanner-bar{height:8px;border-radius:4px;background:rgba(255,255,255,0.05);overflow:hidden;margin-top:8px}
.scanner-fill{height:100%;border-radius:4px;transition:width .6s ease}
.scanner-metrics{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.scanner-metric{text-align:center;padding:8px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.02)}
.scanner-metric-val{font-family:var(--font-mono);font-weight:700;font-size:.85rem}
.scanner-metric-label{font-size:.6rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}

/* Copy trade profiles */
.trader-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:18px;transition:all var(--transition)}
.trader-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,219,164,0.08)}
.trader-header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.trader-avi{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;border:2px solid var(--border-default)}
.trader-name{font-weight:800;font-size:.95rem;color:var(--text-primary)}
.trader-addr{font-family:var(--font-mono);font-size:.7rem;color:var(--text-muted)}
.trader-stats{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.trader-stat{text-align:center;padding:10px 6px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)}
.trader-stat-val{font-family:var(--font-mono);font-weight:700;font-size:.85rem;color:var(--text-primary)}
.trader-stat-label{font-size:.6rem;color:var(--text-muted);margin-top:2px;text-transform:uppercase}
.trader-trades{display:flex;gap:6px;flex-wrap:wrap}
.trader-trade{font-size:.7rem;padding:4px 8px;border-radius:6px;font-family:var(--font-mono);font-weight:600}
.copy-btn{width:100%;margin-top:14px;padding:10px;border-radius:var(--radius-md);border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);font-weight:700;font-size:.8rem;cursor:pointer;font-family:var(--font-body);transition:all var(--transition)}
.copy-btn:hover{background:var(--accent);color:var(--bg-deep)}

/* Watchlist */
.watchlist-empty{text-align:center;padding:60px 20px;color:var(--text-tertiary)}
.watchlist-empty-icon{font-size:3rem;margin-bottom:16px}
.watchlist-hint{font-size:.8rem;color:var(--text-muted);margin-top:8px}
.star-btn{background:none;border:none;cursor:pointer;font-size:1rem;padding:4px;transition:all var(--transition);opacity:0.5}
.star-btn:hover,.star-btn.active{opacity:1;transform:scale(1.15)}

/* View header bar */
.view-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border-subtle)}
.view-header-title{font-weight:800;font-size:1rem;color:var(--text-primary);display:flex;align-items:center;gap:8px}
.view-header-sub{font-size:.75rem;color:var(--text-tertiary)}
.view-header-actions{display:flex;gap:8px}
.view-header-btn{padding:6px 14px;border-radius:var(--radius-sm);border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--font-body);transition:all var(--transition)}
.view-header-btn:hover{border-color:var(--accent);color:var(--accent)}
.view-header-btn.active{border-color:var(--accent);background:var(--accent-dim);color:var(--accent)}
.hdr-btn.connected{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.hdr-btn.connected .wallet-addr-short{font-family:var(--font-mono);font-size:.75rem}

/* Shared panel overlay */
.panel-overlay{position:fixed;inset:0;z-index:1500;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);display:none;align-items:flex-start;justify-content:flex-end;padding:80px 20px 20px}
.panel-overlay.active{display:flex}
.panel{width:420px;max-width:95vw;max-height:calc(100vh - 100px);background:var(--bg-primary);border:1px solid var(--border-default);border-radius:var(--radius-xl);box-shadow:0 24px 80px rgba(0,0,0,0.6);display:flex;flex-direction:column;overflow:hidden;animation:panelSlide .3s cubic-bezier(0.16,1,0.3,1)}
@keyframes panelSlide{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
.panel-header{padding:20px 24px;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-weight:800;font-size:1.05rem;color:var(--text-primary)}
.panel-close{background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-tertiary);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.panel-close:hover{border-color:var(--red);color:var(--red)}
.panel-body{flex:1;overflow-y:auto;padding:16px 24px}
.panel-empty{text-align:center;padding:48px 20px;color:var(--text-tertiary);font-size:.9rem}
.panel-empty-icon{font-size:2.5rem;margin-bottom:12px}

/* Wallet Connect Panel */
.wallet-option{display:flex;align-items:center;gap:14px;padding:16px;border-radius:var(--radius-md);border:1px solid var(--border-default);cursor:pointer;transition:all var(--transition);margin-bottom:10px;background:var(--bg-card)}
.wallet-option:hover{border-color:var(--accent);background:var(--bg-card-hover);transform:translateY(-1px)}
.wallet-option img{width:40px;height:40px;border-radius:10px}
.wallet-option-info{flex:1}
.wallet-option-name{font-weight:700;color:var(--text-primary);font-size:.95rem}
.wallet-option-desc{font-size:.75rem;color:var(--text-tertiary);margin-top:2px}
.wallet-option-tag{font-size:.65rem;padding:3px 8px;border-radius:8px;font-weight:600}
.wallet-option-tag.detected{background:var(--accent-dim);color:var(--accent)}
.wallet-option-tag.not-detected{background:var(--bg-elevated);color:var(--text-muted)}

/* Connected wallet info */
.wallet-info-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px}
.wallet-addr-full{font-family:var(--font-mono);font-size:.8rem;color:var(--text-secondary);word-break:break-all;margin-bottom:12px}
.wallet-balance{font-size:1.8rem;font-weight:800;color:var(--text-primary);margin-bottom:4px}
.wallet-balance-label{font-size:.75rem;color:var(--text-tertiary)}
.wallet-actions{display:flex;gap:8px;margin-top:14px}
.wallet-action-btn{flex:1;padding:10px;border-radius:var(--radius-md);font-size:.8rem;font-weight:600;cursor:pointer;transition:all var(--transition);font-family:var(--font-body);border:1px solid var(--border-default)}
.wallet-action-btn.copy{background:var(--bg-elevated);color:var(--text-secondary)}
.wallet-action-btn.copy:hover{background:var(--bg-card-hover);color:var(--text-primary)}
.wallet-action-btn.disconnect{background:var(--red-dim);color:var(--red);border-color:rgba(255,77,106,0.2)}
.wallet-action-btn.disconnect:hover{background:rgba(255,77,106,0.2)}

/* Portfolio tokens */
.portfolio-token{display:flex;align-items:center;gap:12px;padding:14px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);margin-bottom:8px;transition:all var(--transition)}
.portfolio-token:hover{border-color:var(--border-active);background:var(--bg-card)}
.portfolio-token-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;flex-shrink:0}
.portfolio-token-info{flex:1;min-width:0}
.portfolio-token-name{font-weight:600;font-size:.85rem;color:var(--text-primary)}
.portfolio-token-balance{font-size:.75rem;color:var(--text-tertiary);font-family:var(--font-mono)}
.portfolio-token-val{text-align:right}
.portfolio-token-usd{font-weight:700;font-size:.85rem;color:var(--text-primary)}
.portfolio-token-chg{font-size:.7rem}
.portfolio-total{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:var(--radius-md);background:linear-gradient(135deg,rgba(0,219,164,0.08),rgba(77,166,255,0.06));border:1px solid rgba(0,219,164,0.15);margin-bottom:16px}
.portfolio-total-label{font-size:.75rem;color:var(--text-tertiary);font-weight:600}
.portfolio-total-val{font-size:1.4rem;font-weight:800;color:var(--text-primary)}
.portfolio-loading{text-align:center;padding:30px;color:var(--text-tertiary)}

/* Alerts */
.alert-item{display:flex;align-items:center;gap:12px;padding:14px;border-radius:var(--radius-md);border:1px solid var(--border-subtle);margin-bottom:8px;transition:all var(--transition)}
.alert-item:hover{border-color:var(--border-active);background:var(--bg-card)}
.alert-item-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;flex-shrink:0}
.alert-item-info{flex:1;min-width:0}
.alert-item-name{font-weight:600;font-size:.85rem;color:var(--text-primary)}
.alert-item-cond{font-size:.75rem;color:var(--text-tertiary)}
.alert-item-active{color:var(--accent);font-size:.65rem;font-weight:700;background:var(--accent-dim);padding:3px 8px;border-radius:8px}
.alert-item-remove{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;padding:4px;transition:color var(--transition)}
.alert-item-remove:hover{color:var(--red)}

/* Alert creation form */
.alert-form{background:var(--bg-card);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:16px;margin-bottom:16px}
.alert-form-title{font-weight:700;font-size:.85rem;color:var(--text-primary);margin-bottom:12px}
.alert-form-row{display:flex;gap:8px;margin-bottom:10px}
.alert-form-row select,.alert-form-row input{flex:1;background:var(--bg-elevated);border:1px solid var(--border-default);border-radius:var(--radius-sm);padding:10px 12px;color:var(--text-primary);font-family:var(--font-body);font-size:.8rem}
.alert-form-row select:focus,.alert-form-row input:focus{outline:none;border-color:var(--accent)}
.alert-form-row select option{background:var(--bg-card);color:var(--text-primary)}
.alert-add-btn{width:100%;padding:10px;border-radius:var(--radius-md);background:linear-gradient(135deg,var(--accent),#00c9a7);border:none;color:var(--bg-deep);font-weight:700;font-size:.8rem;cursor:pointer;font-family:var(--font-body);transition:all var(--transition)}
.alert-add-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,219,164,0.3)}

/* Alert toggle in token modal */
.alert-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-radius:var(--radius-md);background:var(--bg-card);border:1px solid var(--border-default);margin-top:12px;cursor:pointer}
.alert-toggle-row:hover{border-color:var(--accent)}
.alert-toggle-label{font-size:.8rem;font-weight:600;color:var(--text-primary)}
.alert-toggle{width:44px;height:24px;border-radius:12px;background:var(--bg-elevated);border:1px solid var(--border-default);position:relative;transition:all var(--transition);cursor:pointer;flex-shrink:0}
.alert-toggle.on{background:var(--accent);border-color:var(--accent)}
.alert-toggle::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:white;transition:all var(--transition)}
.alert-toggle.on::after{left:22px}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="logo-area">
    <div class="logo-mark"><div class="ring"></div><div class="ring"></div><div class="core"></div></div>
    <span class="logo-text">RADAR</span>
    <span class="logo-tag">BETA</span>
  </div>
  <div class="search-wrapper" style="position:relative">
    <div class="search-bar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="searchInput" placeholder="Search tokens, pairs, or wallets..." autocomplete="off" />
      <span class="search-key">⌘K</span>
    </div>
    <div class="search-dropdown" id="searchDropdown"></div>
  </div>
  <div class="header-right">
    <button class="hdr-btn" id="alertsBtn" onclick="openAlerts()"><span class="notif-dot" id="alertDot" style="display:none"></span>🔔 <span class="btn-label">Alerts</span> <span class="alert-count" id="alertCount" style="display:none">0</span></button>
    <button class="hdr-btn" id="portfolioBtn" onclick="openPortfolio()">📊 <span class="btn-label">Portfolio</span></button>
    <button class="hdr-btn glow" id="walletBtn" onclick="connectWallet()">🔗 <span class="btn-label">Connect Wallet</span></button>
  </div>
</header>

<!-- TICKER -->
<div class="ticker-bar">
  <div class="ticker-item"><span class="ticker-dot"></span><span class="ticker-label">Live</span></div>
  <div class="ticker-item"><span class="ticker-label">24h Vol</span><span id="tk-vol"><span class="ticker-val">Loading...</span></span></div>
  <div class="ticker-item"><span class="ticker-label">Tokens</span><span id="tk-pairs"><span class="ticker-val">—</span></span></div>
  <div class="ticker-item"><span class="ticker-label">SOL</span><span id="tk-sol"><span class="ticker-val">Loading...</span></span></div>
  <div class="ticker-item"><span class="ticker-label">ETH</span><span id="tk-eth"><span class="ticker-val">Loading...</span></span></div>
  <div class="ticker-item"><span class="ticker-label">BTC</span><span id="tk-btc"><span class="ticker-val">Loading...</span></span></div>
</div>

<!-- NAV -->
<nav class="nav">
  <div class="nav-item active" data-view="trending">🔥 Trending</div>
  <div class="nav-item" data-view="new">⚡ New Pairs <span class="nav-badge live">LIVE</span></div>
  <div class="nav-item" data-view="gainers">📈 Gainers</div>
  <div class="nav-item" data-view="losers">📉 Losers</div>
  <div class="nav-sep"></div>
  <div class="nav-item" data-view="whales">🐋 Whale Watch <span class="nav-badge ai">AI</span></div>
  <div class="nav-item" data-view="scanner">🧠 AI Scanner <span class="nav-badge ai">AI</span></div>
  <div class="nav-item" data-view="multicharts">📊 Multicharts</div>
  <div class="nav-sep"></div>
  <div class="nav-item" data-view="launchpad">🚀 Launchpad</div>
  <div class="nav-item" data-view="copytrade">👥 Copy Trade</div>
  <div class="nav-item" data-view="watchlist">⭐ Watchlist</div>
</nav>

<!-- FILTERS -->
<div class="filters">
  <div class="chip-group" id="chainChips">
    <div class="chip active" data-chain="all"><span class="dot" style="background:var(--accent)"></span> All Chains</div>
    <div class="chip" data-chain="solana"><span class="dot" style="background:#9945ff"></span> Solana</div>
    <div class="chip" data-chain="eth"><span class="dot" style="background:#627eea"></span> Ethereum</div>
    <div class="chip" data-chain="base"><span class="dot" style="background:#2b6def"></span> Base</div>
    <div class="chip" data-chain="bsc"><span class="dot" style="background:#f0b90b"></span> BSC</div>
    <div class="chip" data-chain="ton"><span class="dot" style="background:#0098ea"></span> TON</div>
  </div>
  <div class="nav-sep"></div>
  <div class="tf-group">
    <button class="tf-btn">5M</button>
    <button class="tf-btn">1H</button>
    <button class="tf-btn active">6H</button>
    <button class="tf-btn">24H</button>
  </div>
  <div class="nav-sep"></div>
  <div class="chip-group"><div class="chip">Vol &gt; $100K</div><div class="chip">Liq &gt; $50K</div></div>
  <div class="ai-shield"><span>🛡️</span> AI Shield — Rug Filter ON</div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="content">
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th style="width:44px" title="RADAR Score: Volume 35% + Momentum 25% + Liquidity 20% + AI Safety 15% + New Bonus 5%">#</th><th>Token</th><th>Price</th><th>AI Score</th><th>Chart</th>
          <th>5M</th><th>1H</th><th>6H</th><th>24H</th><th>Volume</th><th>Liquidity</th><th>MCAP</th><th>Safety</th><th></th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <aside class="sidebar">
    <div class="sb-section">
      <div class="sb-title"><span class="ico">🧠</span> AI Radar Insights</div>
      <div class="insight trend"><div class="insight-head">⚡ TREND ALERT — 2 min ago</div><div class="insight-body"><strong>$ANONYMOUS</strong> seeing unusual cluster buying from 12 wallets linked to a known alpha group. Volume spike 340% in 15 min.</div></div>
      <div class="insight whale"><div class="insight-head">🐋 WHALE MOVE — 8 min ago</div><div class="insight-body">Top Solana whale <strong>7xK2...mP9f</strong> opened a $420K position in <strong>$BUTTCOIN</strong>. 78% win rate over 90 days.</div></div>
      <div class="insight warning"><div class="insight-head">⚠️ RUG WARNING — 14 min ago</div><div class="insight-body"><span class="red-hl">$SAFEMARS</span> dev wallet shows LP removal setup. AI confidence: <span class="red-hl">92% rug probability</span>.</div></div>
    </div>
    <div class="sb-section"><div class="sb-title"><span class="ico">🔥</span> Trend Heatmap</div><div class="heatmap" id="heatmap"></div></div>
    <div class="sb-section"><div class="sb-title"><span class="ico">🐋</span> Smart Money Flow</div><div id="wallets"></div></div>
    <div class="sb-section"><div class="sb-title"><span class="ico">⚡</span> Live Feed</div><div class="feed" id="feed"></div></div>
  </aside>
</div>

<!-- TOKEN DETAIL MODAL -->
<div class="overlay" id="modal">
  <div class="modal">
    <!-- Banner area -->
    <div class="modal-banner" id="modalBanner">
      <div class="unclaimed-banner" id="unclaimedBanner">
        <div class="unclaimed-banner-text">
          🖼️ No banner uploaded — 
          <button class="claim-banner-btn" onclick="openClaim(event)">Claim This Token Profile</button>
        </div>
      </div>
    </div>

    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:0 24px">
      <div class="modal-head">
        <div class="modal-tk">
          <div class="modal-icon-fallback" id="mIcon" style="background:linear-gradient(135deg,#9945ff,#14F195)">🍑</div>
          <div>
            <div class="modal-name" id="mName">Buttcoin <span class="verified-badge" id="mVerified" style="display:none">✓</span></div>
            <div class="modal-pair" id="mPair">BUTT/SOL · Solana</div>
          </div>
          <div class="modal-price-wrap">
            <span class="modal-price" id="mPrice">$0.03929</span>
            <span class="modal-chg up" id="mChg">+44.29%</span>
          </div>
        </div>
      </div>
      <button class="close-btn" onclick="closeModal()">✕</button>
    </div>

    <!-- Social Links -->
    <div class="social-bar" id="socialBar">
      <a class="social-link" href="#">🌐 Website</a>
      <a class="social-link" href="#">𝕏 Twitter</a>
      <a class="social-link" href="#">✈️ Telegram</a>
      <a class="social-link empty" href="#">📸 Instagram</a>
      <a class="social-link empty" href="#">💬 Discord</a>
      <div class="social-sep"></div>
      <button class="claim-profile-btn" onclick="openClaim(event)">✨ Claim & Edit Profile</button>
    </div>

    <div class="modal-content">
      <div class="modal-chart">
        <div class="chart-area" id="chartArea"></div>
      </div>
      <div class="modal-side">
        <div class="trade-box">
          <div class="trade-tabs">
            <div class="t-tab buy-active" onclick="setTab(this,'buy')">BUY</div>
            <div class="t-tab" onclick="setTab(this,'sell')">SELL</div>
          </div>
          <div class="presets"><div class="preset">0.1 SOL</div><div class="preset">0.5 SOL</div><div class="preset">1 SOL</div><div class="preset">5 SOL</div></div>
          <div class="input-group"><div class="input-label">Amount (SOL)</div><input class="trade-input" type="text" value="1.0" /></div>
          <button class="exec-btn buy" id="execBtn">⚡ Quick Buy</button>
        </div>
        <div class="ai-box">
          <div class="ai-box-title">🧠 AI Token Analysis</div>
          <div class="ai-row"><span class="ai-row-label">Rug Probability</span><span class="ai-row-val" style="color:var(--accent)">4% — Low Risk</span></div>
          <div class="ai-row"><span class="ai-row-label">Holder Diversity</span><span class="ai-row-val" style="color:var(--accent)">87/100</span></div>
          <div class="ai-row"><span class="ai-row-label">Volume Authenticity</span><span class="ai-row-val" style="color:var(--orange)">72/100</span></div>
          <div class="ai-row"><span class="ai-row-label">Social Momentum</span><span class="ai-row-val" style="color:var(--accent)">Rising ↑</span></div>
          <div class="ai-row"><span class="ai-row-label">Dev Wallet</span><span class="ai-row-val" style="color:var(--accent)">Renounced ✓</span></div>
          <div class="ai-row"><span class="ai-row-label">LP Status</span><span class="ai-row-val" style="color:var(--accent)">Burned 🔥</span></div>
          <div class="dist">
            <div class="input-label" style="margin-bottom:10px">Top Holder Distribution</div>
            <div class="dist-row"><span class="dist-label">Top 10</span><div class="dist-bar"><div class="dist-fill" style="width:35%;background:var(--orange)"></div></div><span class="dist-pct">35%</span></div>
            <div class="dist-row"><span class="dist-label">Top 50</span><div class="dist-bar"><div class="dist-fill" style="width:58%;background:var(--blue)"></div></div><span class="dist-pct">58%</span></div>
            <div class="dist-row"><span class="dist-label">Others</span><div class="dist-bar"><div class="dist-fill" style="width:42%;background:var(--accent)"></div></div><span class="dist-pct">42%</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CLAIM PROFILE MODAL -->
<div class="claim-overlay" id="claimModal">
  <div class="claim-modal" style="position:relative">
    <button class="claim-close" onclick="closeClaim()">✕</button>
    <div class="claim-header">
      <div class="claim-title">✨ Claim Your Token Profile</div>
      <div class="claim-subtitle">Stand out from the crowd. Add your banner, links, and description — attract more holders and build trust.</div>
    </div>

    <div class="pricing-cards">
      <!-- FREE TIER -->
      <div class="pricing-card free">
        <div class="card-name">🆓 Starter</div>
        <div class="card-price"><span class="free-label">FREE</span></div>
        <div class="card-desc">Get discovered. Basic profile to get your token looking legit.</div>
        <ul class="card-features">
          <li><span class="check">✓</span> Token icon upload</li>
          <li><span class="check">✓</span> Short description (140 chars)</li>
          <li><span class="check">✓</span> 2 social links (X + Telegram)</li>
          <li><span class="x-mark">—</span> No banner image</li>
          <li><span class="x-mark">—</span> No verified badge</li>
          <li><span class="x-mark">—</span> No trending boost</li>
        </ul>
        <button class="card-btn free-btn" onclick="handleFreeClaim()">Get Started — Free</button>
      </div>

      <!-- PRO TIER -->
      <div class="pricing-card pro popular">
        <span class="popular-tag">MOST POPULAR</span>
        <div class="card-name">🚀 Pro</div>
        <div class="card-price"><span class="amount">$49</span> <span class="period">one-time</span></div>
        <div class="card-desc">The full package. Everything your community needs to trust your project.</div>
        <ul class="card-features">
          <li><span class="check">✓</span> Custom banner image</li>
          <li><span class="check">✓</span> Full description + links</li>
          <li><span class="check">✓</span> All social links (X, TG, Discord, IG, Web)</li>
          <li><span class="check">✓</span> <strong style="color:var(--blue)">✓ Verified badge</strong></li>
          <li><span class="check">✓</span> Edit anytime for 30 days</li>
          <li><span class="x-mark">—</span> No trending boost</li>
        </ul>
        <button class="card-btn pro-btn" onclick="handlePayment('pro', 49)">Upgrade to Pro — $49</button>
      </div>

      <!-- BOOST TIER -->
      <div class="pricing-card boost">
        <div class="card-name">⚡ Boost</div>
        <div class="card-price"><span class="amount">$29</span> <span class="period">/ week</span></div>
        <div class="card-desc">Maximum visibility. Get your token in front of every trader on RADAR.</div>
        <ul class="card-features">
          <li><span class="check">✓</span> Everything in Pro</li>
          <li><span class="check">✓</span> <strong style="color:var(--yellow)">⚡ Trending boost</strong></li>
          <li><span class="check">✓</span> Featured in "Hot Picks"</li>
          <li><span class="check">✓</span> Priority in search results</li>
          <li><span class="check">✓</span> Analytics dashboard</li>
          <li><span class="check">✓</span> Unlimited edits</li>
        </ul>
        <button class="card-btn boost-btn" onclick="handlePayment('boost', 29)">Boost Now — $29/wk</button>
      </div>
    </div>

    <!-- Comparison callout -->
    <div class="comparison">
      <div class="comparison-note">
        💡 <span><strong>DexScreener charges $300</strong> for a basic profile with icon + links. On RADAR, you get the same thing <strong>for free</strong> — or get 6x more features for 6x less money.</span>
      </div>
    </div>

    <!-- Community Fund -->
    <div class="community-section">
      <div class="community-card">
        <div class="community-title">👥 Community Fund — Let Your Holders Pay</div>
        <div class="community-desc">
          Can't afford Pro? No problem. Share a funding link with your community — holders can chip in any amount to collectively upgrade your token's profile. When the goal is reached, the profile auto-upgrades.
        </div>
        <div class="fund-progress">
          <div class="fund-bar-bg"><div class="fund-bar-fill" style="width:68%"></div></div>
          <div class="fund-stats">
            <span class="fund-raised">$33.40 raised</span>
            <span class="fund-goal">Goal: $49 (Pro)</span>
          </div>
        </div>
        <div class="fund-contributors">
          <div class="fund-avi" style="background:#9945ff">A</div>
          <div class="fund-avi" style="background:#14F195;color:#000">B</div>
          <div class="fund-avi" style="background:#4da6ff">C</div>
          <div class="fund-avi" style="background:#ff4d6a">D</div>
          <div class="fund-avi" style="background:#ffaa33;color:#000">E</div>
          <span class="fund-count">+12 holders contributed</span>
        </div>
        <button class="contribute-btn" onclick="handleContribute()">💰 Contribute to This Fund</button>
      </div>
    </div>
  </div>
</div>



<!-- WALLET PANEL -->
<div class="panel-overlay" id="walletPanel" onclick="if(event.target===this)closeWalletPanel()">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title" id="walletPanelTitle">Connect Wallet</span>
      <button class="panel-close" onclick="closeWalletPanel()">✕</button>
    </div>
    <div class="panel-body" id="walletPanelBody">
      <!-- Filled by JS -->
    </div>
  </div>
</div>

<!-- PORTFOLIO PANEL -->
<div class="panel-overlay" id="portfolioPanel" onclick="if(event.target===this)closePortfolio()">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">📊 Portfolio</span>
      <button class="panel-close" onclick="closePortfolio()">✕</button>
    </div>
    <div class="panel-body" id="portfolioPanelBody">
      <div class="panel-empty">
        <div class="panel-empty-icon">👛</div>
        Connect your wallet to view your tokens
      </div>
    </div>
  </div>
</div>

<!-- ALERTS PANEL -->
<div class="panel-overlay" id="alertsPanel" onclick="if(event.target===this)closeAlerts()">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">🔔 Price Alerts</span>
      <button class="panel-close" onclick="closeAlerts()">✕</button>
    </div>
    <div class="panel-body" id="alertsPanelBody">
      <!-- Alert creation form -->
      <div class="alert-form" id="alertForm">
        <div class="alert-form-title">Create New Alert</div>
        <div class="alert-form-row">
          <select id="alertTokenSelect">
            <option value="">Select token...</option>
          </select>
        </div>
        <div class="alert-form-row">
          <select id="alertCondition">
            <option value="above">Price goes above</option>
            <option value="below">Price goes below</option>
            <option value="change_up">24h change above %</option>
            <option value="change_down">24h change below %</option>
            <option value="volume">Volume exceeds $</option>
          </select>
        </div>
        <div class="alert-form-row">
          <input type="text" id="alertValue" placeholder="Enter value..." />
        </div>
        <button class="alert-add-btn" onclick="addAlert()">+ Add Alert</button>
      </div>
      <!-- Active alerts list -->
      <div id="alertsList"></div>
    </div>
  </div>
</div>

<script>
// =============================================
// RADAR v5 — LIVE ON-CHAIN DATA ENGINE
// =============================================
//
// DATA ARCHITECTURE:
//
// [Solana Blockchain]
//   ↓ swap events from Raydium, Jupiter, Orca, Meteora, Pump.fun
// [On-Chain Indexers]
//   ↓ parse raw logs, compute prices/volume/liquidity
// [GeckoTerminal API] ← FREE, no auth, CORS OK
//   ↓ trending_pools, new_pools endpoints
// [RADAR Frontend]
//   ↓ ranking algorithm, AI safety scoring
// [User sees: real trending tokens with real data]
//
// DexScreener uses the SAME on-chain data (they build their own indexer).
// GeckoTerminal indexes the same DEX swap events.
// In production, RADAR replaces this with own Helius/Shyft Geyser gRPC indexer.
//
// Charts: GeckoTerminal embeds (same underlying data)
// Ticker: CoinGecko simple/price
// Token images: GeckoTerminal token info (from on-chain metadata + Jupiter registry)
// =============================================

const GT_BASE = 'https://api.geckoterminal.com/api/v2';
const gradients = [
  ['#9945ff','#14F195'], ['#ff4d6a','#ff9a56'], ['#4da6ff','#a78bfa'],
  ['#00dba4','#4da6ff'], ['#ffd166','#ff6b6b'], ['#14F195','#00dba4'],
  ['#ff6b6b','#9945ff'], ['#a78bfa','#4da6ff'], ['#ffaa33','#ff4d6a'],
  ['#627eea','#a78bfa'], ['#0098ea','#00dba4'], ['#f0b90b','#ff9a56'],
];

// =============================================
// MULTI-CHAIN CONFIG
// =============================================
let currentNetwork = 'solana'; // solana | eth | base | bsc | ton
const CHAIN_CONFIG = {
  solana:  { label: 'SOL', color: '#9945ff', quoteDefault: 'SOL',  gecko: 'solana' },
  eth:     { label: 'ETH', color: '#627eea', quoteDefault: 'WETH', gecko: 'eth' },
  base:    { label: 'BASE', color: '#2b6def', quoteDefault: 'WETH', gecko: 'base' },
  bsc:     { label: 'BSC', color: '#f0b90b', quoteDefault: 'WBNB', gecko: 'bsc' },
  ton:     { label: 'TON', color: '#0098ea', quoteDefault: 'TON',  gecko: 'ton' },
};
// "All Chains" uses these networks in rotation
const ALL_CHAINS = ['solana', 'eth', 'base', 'bsc', 'ton'];

let tokens = [];
let isLoading = true;
let currentView = 'trending'; // trending | new | gainers

// =============================================
// API: Fetch pools from GeckoTerminal (any chain)
// =============================================
async function fetchTrending(network) {
  const net = network || currentNetwork;
  try {
    const url = `${GT_BASE}/networks/${CHAIN_CONFIG[net].gecko}/trending_pools?include=base_token,quote_token&page=1`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const json = await res.json();
    return parsePools(json, net);
  } catch (err) { console.error('Trending fetch failed:', err); return null; }
}

async function fetchNewPools(network) {
  const net = network || currentNetwork;
  try {
    const url = `${GT_BASE}/networks/${CHAIN_CONFIG[net].gecko}/new_pools?include=base_token,quote_token&page=1`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const json = await res.json();
    return parsePools(json, net);
  } catch (err) { console.error('New pools fetch failed:', err); return null; }
}

async function fetchTopPools(network) {
  const net = network || currentNetwork;
  try {
    const url = `${GT_BASE}/networks/${CHAIN_CONFIG[net].gecko}/pools?sort=h24_volume_usd_desc&include=base_token,quote_token&page=1`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const json = await res.json();
    return parsePools(json, net);
  } catch (err) { console.error('Top pools fetch failed:', err); return null; }
}

// "All Chains" — fetch top trending from all networks, merge & rank
async function fetchAllChainsTrending() {
  try {
    const promises = ALL_CHAINS.map(net => fetchTrending(net).catch(() => []));
    const results = await Promise.all(promises);
    const merged = results.flat().filter(Boolean);
    // Sort by volume to interleave fairly
    merged.sort((a, b) => b.volRaw - a.volRaw);
    return merged.slice(0, 30);
  } catch (err) { console.error('All chains fetch failed:', err); return null; }
}

async function fetchAllChainsNew() {
  try {
    const promises = ALL_CHAINS.map(net => fetchNewPools(net).catch(() => []));
    const results = await Promise.all(promises);
    return results.flat().filter(Boolean).sort((a, b) => a.ageH - b.ageH).slice(0, 30);
  } catch (err) { return null; }
}

async function fetchAllChainsTop() {
  try {
    const promises = ALL_CHAINS.map(net => fetchTopPools(net).catch(() => []));
    const results = await Promise.all(promises);
    return results.flat().filter(Boolean).sort((a, b) => b.volRaw - a.volRaw).slice(0, 30);
  } catch (err) { return null; }
}

// =============================================
// PARSE: Transform GeckoTerminal response → RADAR format
// =============================================
function parsePools(json, network) {
  if (!json?.data?.length) return [];
  const net = network || currentNetwork;
  const chainCfg = CHAIN_CONFIG[net] || CHAIN_CONFIG.solana;

  // Build included token lookup
  const tokenLookup = {};
  if (json.included) {
    json.included.forEach(inc => {
      if (inc.type === 'token') {
        tokenLookup[inc.id] = inc.attributes;
      }
    });
  }

  // Deduplicate by base token address — keep highest volume pool per token
  const seen = {};
  
  return json.data
    .map(pool => {
      const a = pool.attributes;
      if (!a) return null;

      // Get base token info from included data
      const baseTokenRel = pool.relationships?.base_token?.data;
      const quoteTokenRel = pool.relationships?.quote_token?.data;
      const baseTokenData = baseTokenRel ? tokenLookup[baseTokenRel.id] : null;
      const quoteTokenData = quoteTokenRel ? tokenLookup[quoteTokenRel.id] : null;

      const name = baseTokenData?.name || a.name?.split('/')[0]?.trim() || 'Unknown';
      const symbol = baseTokenData?.symbol || a.name?.split('/')[0]?.trim() || '???';
      const quoteSymbol = quoteTokenData?.symbol || a.name?.split('/')?.[1]?.trim() || chainCfg.quoteDefault;
      const imageUrl = baseTokenData?.image_url || null;
      const baseAddr = baseTokenData?.address || '';

      // Skip if we already have a higher-volume pool for this token
      const vol24 = parseFloat(a.volume_usd?.h24) || 0;
      if (seen[baseAddr] && seen[baseAddr] >= vol24) return null;
      seen[baseAddr] = vol24;

      // Parse age
      const createdAt = a.pool_created_at ? new Date(a.pool_created_at).getTime() : Date.now();
      const ageMs = Date.now() - createdAt;
      const ageH = Math.floor(ageMs / 3600000);
      let ageStr;
      if (ageH < 1) ageStr = Math.max(1, Math.floor(ageMs / 60000)) + 'm';
      else if (ageH < 24) ageStr = ageH + 'h';
      else if (ageH < 720) ageStr = Math.floor(ageH / 24) + 'd';
      else ageStr = Math.floor(ageH / 720) + 'mo';

      // Price changes
      const h24 = parseFloat(a.price_change_percentage?.h24) || 0;
      const h6  = parseFloat(a.price_change_percentage?.h6) || 0;
      const h1  = parseFloat(a.price_change_percentage?.h1) || 0;
      const m5  = parseFloat(a.price_change_percentage?.m5) || 0;

      // Volume & liquidity
      const liq = parseFloat(a.reserve_in_usd) || 0;
      const volH1 = parseFloat(a.volume_usd?.h1) || 0;

      // Transactions
      const buys24  = a.transactions?.h24?.buys || 0;
      const sells24 = a.transactions?.h24?.sells || 0;
      const txns24  = buys24 + sells24;
      const buyers24 = a.transactions?.h24?.buyers || 0;
      const sellers24 = a.transactions?.h24?.sellers || 0;
      const buyRatio = txns24 > 0 ? buys24 / txns24 : 0.5;

      // AI Safety Score — heuristic from real on-chain signals
      let ai = 50;
      if (liq > 500000) ai += 15; else if (liq > 100000) ai += 10; else if (liq > 50000) ai += 5; else if (liq < 5000) ai -= 20;
      if (vol24 > 5000000) ai += 12; else if (vol24 > 1000000) ai += 8; else if (vol24 > 100000) ai += 4;
      if (ageH > 720) ai += 10; else if (ageH > 168) ai += 7; else if (ageH > 24) ai += 3; else if (ageH < 1) ai -= 10;
      if (txns24 > 50000) ai += 10; else if (txns24 > 5000) ai += 7; else if (txns24 > 500) ai += 3;
      if (buyRatio > 0.3 && buyRatio < 0.7) ai += 5; // healthy distribution
      if (buyers24 > 500) ai += 5; // many unique buyers
      ai = Math.max(5, Math.min(98, ai));
      const safe = ai >= 70 ? 'safe' : ai >= 40 ? 'warn' : 'danger';

      // FDV / Market Cap
      const fdv = parseFloat(a.fdv_usd) || 0;
      const mc = parseFloat(a.market_cap_usd) || fdv;

      return {
        name, tick: symbol, pair: quoteSymbol,
        chain: chainCfg.label, cc: chainCfg.color, network: net,
        p: parseFloat(a.base_token_price_usd) || 0,
        m5, h1, h6, h24,
        volRaw: vol24, volH1, liqRaw: liq, mcRaw: mc || fdv,
        ai, safe, age: ageStr, ageH,
        verified: !!imageUrl,
        hasBanner: false,
        imageUrl,
        poolAddress: a.address,
        baseAddr,
        txns24, buyRatio, buyers24, sellers24,
        buys24, sells24,
      };
    })
    .filter(t => t && t.p > 0)
    // Remove duplicates by base address, keeping first (highest priority in trending)
    .filter((t, i, arr) => arr.findIndex(x => x.baseAddr === t.baseAddr) === i);
}

// =============================================
// LOAD DATA (called on init and refresh)
// =============================================
async function loadData(view) {
  currentView = view || currentView;
  let result;
  
  // Map views to API calls
  const apiView = currentView === 'losers' ? 'gainers' : currentView === 'launchpad' ? 'new' : currentView;
  const isAll = currentNetwork === 'all';
  
  if (apiView === 'new') {
    result = isAll ? await fetchAllChainsNew() : await fetchNewPools();
  } else if (apiView === 'gainers') {
    result = isAll ? await fetchAllChainsTop() : await fetchTopPools();
  } else {
    result = isAll ? await fetchAllChainsTrending() : await fetchTrending();
  }

  if (result && result.length) {
    tokens = result;
    rankTokens(tokens);
    isLoading = false;
    render();
    renderHeat();
    renderDynamicFeed();
    renderWallets();
  } else if (isLoading) {
    const tb = document.getElementById('tbody');
    if (tb) tb.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:40px;color:var(--red)">⚠️ Failed to load — retrying...</td></tr>';
    setTimeout(() => loadData(currentView), 5000);
  }
}

// =============================================
// TICKER: SOL/ETH/BTC from CoinGecko
// =============================================
async function fetchTickerPrices() {
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana,ethereum,bitcoin&vs_currencies=usd&include_24hr_change=true');
    const d = await res.json();
    const fmt = v => v >= 1000 ? '$' + v.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '$' + v.toFixed(2);
    const chgF = v => (v >= 0 ? '↑' : '↓') + Math.abs(v).toFixed(1) + '%';
    const cls = v => v >= 0 ? 'up' : 'down';
    if (d.solana) {
      solPriceUSD = d.solana.usd;
      document.getElementById('tk-sol').innerHTML = `<span class="ticker-val ${cls(d.solana.usd_24h_change)}">${fmt(d.solana.usd)} ${chgF(d.solana.usd_24h_change)}</span>`;
    }
    if (d.ethereum) document.getElementById('tk-eth').innerHTML = `<span class="ticker-val ${cls(d.ethereum.usd_24h_change)}">${fmt(d.ethereum.usd)} ${chgF(d.ethereum.usd_24h_change)}</span>`;
    if (d.bitcoin) document.getElementById('tk-btc').innerHTML = `<span class="ticker-val ${cls(d.bitcoin.usd_24h_change)}">${fmt(d.bitcoin.usd)} ${chgF(d.bitcoin.usd_24h_change)}</span>`;
    if (tokens.length) {
      const totalVol = tokens.reduce((s, t) => s + t.volRaw, 0);
      document.getElementById('tk-vol').innerHTML = `<span class="ticker-val">$${fmtVol(totalVol)}</span>`;
      document.getElementById('tk-pairs').innerHTML = `<span class="ticker-val up">${tokens.length} trending</span>`;
    }
  } catch (err) { console.error('Ticker failed:', err); }
}

// =============================================
// RANKING — Composite RADAR Score
// =============================================
// Volume 35% | Momentum 25% | Liquidity 20% | AI Safety 15% | Newness 5%
function rankTokens(list) {
  if (!list.length) return list;
  const maxVol = Math.max(...list.map(t => t.volRaw)) || 1;
  const maxLiq = Math.max(...list.map(t => t.liqRaw)) || 1;
  const maxMom = Math.max(...list.map(t => Math.abs(t.h24))) || 1;
  list.forEach(t => {
    const vol = (t.volRaw / maxVol) * 35;
    const mom = (Math.abs(t.h24) / maxMom) * 25;
    const liq = (t.liqRaw / maxLiq) * 20;
    const aiS = (t.ai / 100) * 15;
    const nb  = t.ageH <= 6 ? 5 : t.ageH <= 24 ? 3 : t.ageH <= 72 ? 1 : 0;
    const momAdj = t.h24 < 0 ? mom * 0.4 : mom;
    const pen = t.safe === 'danger' ? 0.7 : t.safe === 'warn' ? 0.9 : 1;
    t._score = (vol + momAdj + liq + aiS + nb) * pen;
  });
  list.sort((a, b) => b._score - a._score);
  list.forEach((t, i) => t.rank = i + 1);
  return list;
}

// =============================================
// FORMAT HELPERS
// =============================================
function fmtPrice(p) {
  if (!p || p === 0) return '$0';
  if (p >= 1000) return '$' + p.toLocaleString('en-US', { maximumFractionDigits: 2 });
  if (p >= 1) return '$' + p.toFixed(2);
  if (p >= 0.001) return '$' + p.toFixed(5);
  // Subscript notation for very small prices: $0.0₅1234
  const str = p.toFixed(20);
  const match = str.match(/^0\.(0+)/);
  if (match && match[1].length > 3) {
    const zeros = match[1].length;
    const sig = p.toFixed(zeros + 4).replace(/^0\.0+/, '');
    return `$0.0<sub>${zeros}</sub>${sig.slice(0, 4)}`;
  }
  return '$' + p.toExponential(2);
}
function fmtVol(v) {
  if (v >= 1e9) return (v / 1e9).toFixed(1) + 'B';
  if (v >= 1e6) return (v / 1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v / 1e3).toFixed(0) + 'K';
  return v.toFixed(0);
}
function fmtMc(v) {
  if (v >= 1e9) return (v / 1e9).toFixed(2) + 'B';
  if (v >= 1e6) return (v / 1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v / 1e3).toFixed(0) + 'K';
  return v.toFixed(0);
}
const chg = v => {
  if (v == null || isNaN(v)) return '<span class="chg" style="color:var(--text-muted)">—</span>';
  const c = v >= 0 ? 'up' : 'down';
  return `<span class="chg ${c}">${v >= 0 ? '+' : ''}${v.toFixed(2)}%</span>`;
};
const aiHTML = s => {
  const c = s >= 70 ? 'high' : s >= 40 ? 'mid' : 'low';
  return `<div class="ai-score"><div class="ai-bar"><div class="ai-fill ${c}" style="width:${s}%"></div></div><span class="ai-num ${c}">${s}</span></div>`;
};
const safeHTML = s => {
  const m = { safe: '✓ SAFE', warn: '⚠ CAUTION', danger: '☠ DANGER' };
  return `<span class="safety ${s}">${m[s]}</span>`;
};

function tokenImgHTML(t, size) {
  const sz = size || 36;
  const g = gradients[((t.rank || 1) - 1) % gradients.length];
  if (t.imageUrl) {
    return `<img class="tk-img" src="${t.imageUrl}" width="${sz}" height="${sz}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="${t.name}"><div class="tk-img-fallback" style="display:none;width:${sz}px;height:${sz}px;background:linear-gradient(135deg,${g[0]},${g[1]})">${t.tick[0]}</div>`;
  }
  return `<div class="tk-img-fallback" style="width:${sz}px;height:${sz}px;background:linear-gradient(135deg,${g[0]},${g[1]});font-size:${sz * .4}px">${t.tick[0]}</div>`;
}

function sparkSVG(t) {
  const vals = [t.h24 || 0, t.h6 || 0, t.h1 || 0, t.m5 || 0];
  const pts = [];
  for (let i = 0; i < 22; i++) {
    const seg = (i / 21) * 3;
    const idx = Math.min(Math.floor(seg), 2);
    const frac = seg - idx;
    const v = vals[idx] * (1 - frac) + vals[Math.min(idx + 1, 3)] * frac;
    pts.push(16 + v * 0.08 + (Math.random() - 0.5) * 1.5);
  }
  const mn = Math.min(...pts), mx = Math.max(...pts), range = mx - mn || 1;
  const d = pts.map((v, i) => `${(i / 21) * 88},${32 - ((v - mn) / range) * 28}`).join(' ');
  const up = (t.h24 || 0) >= 0;
  const col = up ? 'var(--accent)' : 'var(--red)';
  const ly = 32 - ((pts[21] - mn) / range) * 28;
  return `<div class="spark"><svg viewBox="0 0 88 32"><defs><linearGradient id="sg${t.rank}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${col}" stop-opacity="0.15"/><stop offset="100%" stop-color="${col}" stop-opacity="0"/></linearGradient></defs><polygon points="0,32 ${d} 88,32" fill="url(#sg${t.rank})"/><polyline points="${d}" fill="none" stroke="${col}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="88" cy="${ly}" r="2.5" fill="${col}" opacity="0.8"/></svg></div>`;
}

// =============================================
// RENDER TABLE
// =============================================
function render() {
  if (isLoading) {
    document.getElementById('tbody').innerHTML = '<tr><td colspan="14" style="text-align:center;padding:60px;color:var(--text-muted)"><div class="chart-loading" style="position:static;background:none"><div class="spinner"></div>Fetching trending tokens from on-chain data...</div></td></tr>';
    return;
  }
  document.getElementById('tbody').innerHTML = tokens.map((t, i) => `
    <tr onclick="openModal(${i})" style="animation-delay:${i * 0.04}s">
      <td><span class="rank ${t.rank <= 3 ? 'gold' : ''}">${t.rank}</span></td>
      <td><div class="tk">${tokenImgHTML(t)}<div><div class="tk-name">${t.name}${t.verified ? ' <span class="verified-badge">✓</span>' : ''}<span class="chain-dot" style="background:${t.cc}"></span>${t.ageH <= 6 ? '<span class="new-tag">NEW</span>' : ''}</div><div class="tk-sub">${t.tick}/${t.pair} · ${t.age}</div></div></div></td>
      <td class="price">${fmtPrice(t.p)}</td>
      <td>${aiHTML(t.ai)}</td>
      <td>${sparkSVG(t)}</td>
      <td>${chg(t.m5)}</td>
      <td>${chg(t.h1)}</td>
      <td>${chg(t.h6)}</td>
      <td>${chg(t.h24)}</td>
      <td class="muted">$${fmtVol(t.volRaw)}</td>
      <td class="muted">$${fmtVol(t.liqRaw)}</td>
      <td class="muted">$${fmtMc(t.mcRaw)}</td>
      <td>${safeHTML(t.safe)}</td>
      <td><div class="qt"><button class="qt-btn qt-buy" onclick="event.stopPropagation()">BUY</button><button class="qt-btn qt-sell" onclick="event.stopPropagation()">SELL</button></div></td>
    </tr>
  `).join('');
}

// =============================================
// SIDEBAR
// =============================================
function renderHeat() {
  if (!tokens.length) return;
  document.getElementById('heatmap').innerHTML = tokens.slice(0, 12).map(t => {
    const i = Math.min(Math.abs(t.h24) / 100, 1);
    const bg = t.h24 >= 0 ? `rgba(0,219,164,${.1 + i * .45})` : `rgba(255,77,106,${.1 + i * .45})`;
    const v = Math.abs(t.h24) > 999 ? (t.h24 / 1000).toFixed(1) + 'K' : t.h24.toFixed(1);
    return `<div class="heat" style="background:${bg}"><span class="h-name">${t.tick}</span><span class="h-val">${t.h24 > 0 ? '+' : ''}${v}%</span></div>`;
  }).join('');
}

function renderWallets() {
  if (!tokens.length) return;
  const picks = tokens.slice(0, 4);
  const w = picks.map((t, i) => {
    const isBuy = t.h1 > 0;
    const icons = ['🐋', '🦈', '🐳', '🦑'];
    const amts = ['$420K', '$180K', '$95K', '$2.1M'];
    return {
      a: t.baseAddr ? t.baseAddr.slice(0,4) + '...' + t.baseAddr.slice(-4) : '????...????',
      act: isBuy ? `Bought ${amts[i]}` : `Sold ${amts[i]}`,
      t: isBuy ? 'buy' : 'sell', tok: t.tick,
      pnl: isBuy ? '+$' + Math.floor(Math.random() * 500 + 50) + 'K' : '-$' + Math.floor(Math.random() * 100 + 10) + 'K',
      pc: isBuy ? 'up' : 'down', i: icons[i]
    };
  });
  document.getElementById('wallets').innerHTML = w.map(x => `<div class="wallet-row"><div class="wallet-avi">${x.i}</div><div class="wallet-info"><div class="wallet-addr">${x.a}</div><div class="wallet-act ${x.t}">${x.act} of ${x.tok}</div></div><div class="wallet-pnl ${x.pc}">${x.pnl}</div></div>`).join('');
}

function renderDynamicFeed() {
  if (!tokens.length) return;
  const data = [];
  for (let i = 0; i < 10; i++) {
    const t = tokens[Math.floor(Math.random() * Math.min(tokens.length, 15))];
    const isBuy = Math.random() > 0.4;
    data.push({
      t: `${i * 3 + Math.floor(Math.random() * 3)}s`,
      a: isBuy ? 'BUY' : 'SELL', c: isBuy ? 'buy' : 'sell',
      tok: t.tick, amt: `$${(Math.random() * 50 + 0.5).toFixed(1)}K`
    });
  }
  document.getElementById('feed').innerHTML = data.map(f => `<div class="feed-row"><span class="feed-time">${f.t}</span><span class="feed-type ${f.c}">${f.a}</span><span class="feed-tok">${f.tok}</span><span class="feed-amt">${f.amt}</span></div>`).join('');
}

// =============================================
// MODAL — Token Detail with Chart
// =============================================
function openModal(i) {
  const t = tokens[i];
  if (!t) return;
  currentModalToken = t.tick;
  const g = gradients[((t.rank || 1) - 1) % gradients.length];

  // Banner
  const banner = document.getElementById('modalBanner');
  banner.innerHTML = `<div class="unclaimed-banner"><div class="unclaimed-banner-text">🖼️ No banner uploaded — <button class="claim-banner-btn" onclick="openClaim(event)">Claim This Token Profile</button></div></div>`;

  // Icon
  const iconEl = document.getElementById('mIcon');
  if (t.imageUrl) {
    iconEl.outerHTML = `<img class="modal-icon" id="mIcon" src="${t.imageUrl}" width="56" height="56" style="border-radius:var(--radius-md);border:3px solid var(--bg-primary)" onerror="this.outerHTML='<div class=\\'modal-icon-fallback\\' id=\\'mIcon\\' style=\\'background:linear-gradient(135deg,${g[0]},${g[1]})\\'>${t.tick[0]}</div>'">`;
  } else {
    iconEl.outerHTML = `<div class="modal-icon-fallback" id="mIcon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${t.tick[0]}</div>`;
  }

  document.getElementById('mName').innerHTML = `${t.name} ${t.verified ? '<span class="verified-badge">✓</span>' : ''}`;
  document.getElementById('mPair').textContent = `${t.tick}/${t.pair} · Solana`;
  document.getElementById('mPrice').innerHTML = fmtPrice(t.p);
  const ce = document.getElementById('mChg');
  ce.textContent = `${t.h24 >= 0 ? '+' : ''}${t.h24.toFixed(2)}%`;
  ce.className = `modal-chg ${t.h24 >= 0 ? 'up' : 'down'}`;

  // Social links
  const sb = document.getElementById('socialBar');
  sb.innerHTML = `
    <a class="social-link empty">🌐 Website</a>
    <a class="social-link empty">𝕏 Twitter</a>
    <a class="social-link empty">✈️ Telegram</a>
    <a class="social-link empty">💬 Discord</a>
    <div class="social-sep"></div>
    <button class="claim-profile-btn" onclick="openClaim(event)">✨ Claim & Edit Profile</button>
  `;

  // Try to fetch token info for socials
  const tokenNetwork = (t.network && CHAIN_CONFIG[t.network]) ? CHAIN_CONFIG[t.network].gecko : 'solana';
  if (t.poolAddress) {
    fetch(`${GT_BASE}/networks/${tokenNetwork}/pools/${t.poolAddress}/info`)
      .then(r => r.json())
      .then(info => {
        const attrs = info?.data?.attributes;
        if (!attrs) return;
        let html = '';
        const sites = attrs.websites || [];
        const socials = attrs.socials || [];
        const site = sites[0]?.url || sites[0];
        html += site ? `<a class="social-link" href="${site}" target="_blank">🌐 Website</a>` : '<a class="social-link empty">🌐 Website</a>';
        const tw = socials.find(s => s.type === 'twitter');
        html += tw ? `<a class="social-link" href="${tw.url}" target="_blank">𝕏 Twitter</a>` : '<a class="social-link empty">𝕏 Twitter</a>';
        const tg = socials.find(s => s.type === 'telegram');
        html += tg ? `<a class="social-link" href="${tg.url}" target="_blank">✈️ Telegram</a>` : '<a class="social-link empty">✈️ Telegram</a>';
        const dc = socials.find(s => s.type === 'discord');
        html += dc ? `<a class="social-link" href="${dc.url}" target="_blank">💬 Discord</a>` : '<a class="social-link empty">💬 Discord</a>';
        html += '<div class="social-sep"></div><button class="claim-profile-btn" onclick="openClaim(event)">✨ Claim & Edit Profile</button>';
        sb.innerHTML = html;
      }).catch(() => {});
  }

  // ---- CHART: GeckoTerminal Embed ----
  // Same on-chain data as DexScreener, reliable iframe embedding
  const chartEl = document.getElementById('chartArea');
  if (t.poolAddress) {
    const embedUrl = `https://www.geckoterminal.com/${tokenNetwork}/pools/${t.poolAddress}?embed=1&info=0&swaps=0&grayscale=0&light_chart=0`;
    chartEl.innerHTML = `
      <div class="chart-loading" id="chartLoader"><div class="spinner"></div>Loading chart...</div>
      <iframe
        src="${embedUrl}"
        style="width:100%;height:100%;border:none;border-radius:var(--radius-lg)"
        loading="eager"
        allow="clipboard-write"
        sandbox="allow-scripts allow-same-origin allow-popups"
        onload="var cl=document.getElementById('chartLoader');if(cl)cl.style.display='none'"
      ></iframe>`;
  } else {
    chartEl.innerHTML = '<div class="chart-loading">Chart unavailable for this pair</div>';
  }

  // AI Analysis
  const rugProb = Math.max(2, 100 - t.ai);
  const rc = rugProb <= 20 ? 'var(--accent)' : rugProb <= 50 ? 'var(--orange)' : 'var(--red)';
  const rl = rugProb <= 20 ? 'Low Risk' : rugProb <= 50 ? 'Medium Risk' : 'High Risk';
  document.querySelector('.ai-box').innerHTML = `
    <div class="ai-box-title">🧠 AI Token Analysis</div>
    <div class="ai-row"><span class="ai-row-label">Rug Probability</span><span class="ai-row-val" style="color:${rc}">${rugProb}% — ${rl}</span></div>
    <div class="ai-row"><span class="ai-row-label">24h Volume</span><span class="ai-row-val" style="color:var(--text-primary)">$${fmtVol(t.volRaw)}</span></div>
    <div class="ai-row"><span class="ai-row-label">Liquidity</span><span class="ai-row-val" style="color:${t.liqRaw > 100000 ? 'var(--accent)' : 'var(--orange)'}">$${fmtVol(t.liqRaw)}</span></div>
    <div class="ai-row"><span class="ai-row-label">24h Transactions</span><span class="ai-row-val" style="color:var(--text-primary)">${(t.txns24 || 0).toLocaleString()}</span></div>
    <div class="ai-row"><span class="ai-row-label">24h Buys / Sells</span><span class="ai-row-val" style="color:var(--text-primary)">${(t.buys24||0).toLocaleString()} / ${(t.sells24||0).toLocaleString()}</span></div>
    <div class="ai-row"><span class="ai-row-label">Buy Ratio</span><span class="ai-row-val" style="color:${t.buyRatio > 0.5 ? 'var(--accent)' : 'var(--red)'}">${((t.buyRatio || 0.5) * 100).toFixed(0)}% buys</span></div>
    <div class="ai-row"><span class="ai-row-label">Unique Buyers</span><span class="ai-row-val" style="color:var(--text-primary)">${(t.buyers24 || 0).toLocaleString()}</span></div>
    <div class="ai-row"><span class="ai-row-label">Market Cap</span><span class="ai-row-val" style="color:var(--text-primary)">$${fmtMc(t.mcRaw)}</span></div>
    <div class="ai-row"><span class="ai-row-label">Pair Age</span><span class="ai-row-val" style="color:var(--text-primary)">${t.age}</span></div>
    <div class="dist">
      <div class="input-label" style="margin-bottom:10px">RADAR Safety Score</div>
      <div class="dist-row"><span class="dist-label">Score</span><div class="dist-bar"><div class="dist-fill" style="width:${t.ai}%;background:${t.ai >= 70 ? 'var(--accent)' : t.ai >= 40 ? 'var(--orange)' : 'var(--red)'}"></div></div><span class="dist-pct">${t.ai}</span></div>
    </div>`;

  document.getElementById('modal').classList.add('active');
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  document.getElementById('chartArea').innerHTML = '';
}
document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });

// Claim Profile Modal
function openClaim(e) { e && e.stopPropagation(); document.getElementById('claimModal').classList.add('active'); resetClaimModal(); }
function closeClaim() { document.getElementById('claimModal').classList.remove('active'); }
document.getElementById('claimModal').addEventListener('click', e => { if (e.target.id === 'claimModal') closeClaim(); });

// Reset claim modal to default pricing view
let _pricingCardsOriginal = '';
function resetClaimModal() {
  const container = document.querySelector('.pricing-cards');
  if (_pricingCardsOriginal && container) container.innerHTML = _pricingCardsOriginal;
  const commCard = document.querySelector('.community-card');
  if (commCard && commCard.dataset.original) commCard.innerHTML = commCard.dataset.original;
}

// Store original card HTML on load
setTimeout(() => {
  const container = document.querySelector('.pricing-cards');
  if (container) _pricingCardsOriginal = container.innerHTML;
  const commCard = document.querySelector('.community-card');
  if (commCard) commCard.dataset.original = commCard.innerHTML;
}, 500);

// =============================================
// FREE TIER — In-app claim form
// =============================================
function handleFreeClaim() {
  const card = document.querySelector('.pricing-card.free');
  card.innerHTML = `
    <div class="claim-form">
      <div style="font-weight:800;font-size:.95rem;margin-bottom:12px;color:var(--accent)">🆓 Claim Free Profile</div>
      <div class="claim-form-group">
        <div class="claim-form-label">Token Icon URL</div>
        <input class="claim-form-input" id="claimIcon" placeholder="https://yoursite.com/icon.png" type="url">
      </div>
      <div class="claim-form-group">
        <div class="claim-form-label">Short Description (140 chars)</div>
        <textarea class="claim-form-input" id="claimDesc" maxlength="140" placeholder="What makes your token unique?"></textarea>
      </div>
      <div class="claim-form-group">
        <div class="claim-form-label">X (Twitter) Link</div>
        <input class="claim-form-input" id="claimX" placeholder="https://x.com/yourtoken" type="url">
      </div>
      <div class="claim-form-group">
        <div class="claim-form-label">Telegram Link</div>
        <input class="claim-form-input" id="claimTg" placeholder="https://t.me/yourgroup" type="url">
      </div>
      <button class="claim-form-submit" onclick="submitFreeClaim()">✓ Claim Profile — Free</button>
    </div>
  `;
}

function submitFreeClaim() {
  const data = {
    icon: document.getElementById('claimIcon')?.value || '',
    desc: document.getElementById('claimDesc')?.value || '',
    x: document.getElementById('claimX')?.value || '',
    tg: document.getElementById('claimTg')?.value || '',
    tier: 'free',
    claimed: Date.now()
  };
  // Save to localStorage
  const claims = JSON.parse(localStorage.getItem('radar_claims') || '{}');
  claims[currentModalToken || 'unknown'] = data;
  localStorage.setItem('radar_claims', JSON.stringify(claims));
  
  const card = document.querySelector('.pricing-card.free');
  card.innerHTML = `
    <div class="payment-status">
      <div class="payment-success">✅</div>
      <div style="font-weight:800;font-size:1rem;margin-bottom:6px">Profile Claimed!</div>
      <div style="font-size:.8rem;color:var(--text-tertiary);line-height:1.5">Your free profile is now active. Upgrade to Pro anytime for verified badge and full customization.</div>
    </div>
  `;
}

// Track which token the modal is open for
let currentModalToken = null;
const _origOpenClaim = openClaim;

// =============================================
// PAID TIERS — SOL payment via Phantom
// =============================================
function handlePayment(tier, usdAmount) {
  // Check wallet connection
  if (!connectedWallet || !walletPublicKey) {
    showPaymentToast('🔗 Connect your wallet first', 'Connect Phantom or Solflare to make payments.');
    connectWallet();
    return;
  }
  
  // Check SOL price is available
  if (!solPriceUSD || solPriceUSD <= 0) {
    showPaymentToast('⏳ Loading prices...', 'SOL price is still loading. Please try again in a moment.');
    fetchTickerPrices();
    return;
  }
  
  const solAmount = (usdAmount / solPriceUSD);
  const solDisplay = solAmount.toFixed(4);
  const tierNames = { pro: '🚀 Pro Profile', boost: '⚡ Boost (1 Week)' };
  const tierColors = { pro: 'var(--blue)', boost: 'var(--yellow)' };
  
  const cardClass = tier === 'pro' ? '.pricing-card.pro' : '.pricing-card.boost';
  const card = document.querySelector(cardClass);
  
  card.innerHTML = `
    <div class="payment-confirm">
      <div class="payment-confirm-title">${tierNames[tier]}</div>
      <div class="payment-confirm-sub">Confirm your payment via ${connectedWallet === 'phantom' ? 'Phantom' : 'Solflare'}</div>
      <div class="payment-sol-amount">◎ ${solDisplay}</div>
      <div class="payment-usd-equiv">≈ $${usdAmount} USD at $${solPriceUSD.toFixed(2)}/SOL</div>
      <div class="payment-detail"><span class="payment-detail-label">From</span><span class="payment-detail-val addr">${walletPublicKey.slice(0,8)}...${walletPublicKey.slice(-8)}</span></div>
      <div class="payment-detail"><span class="payment-detail-label">To</span><span class="payment-detail-val addr">RADAR Treasury</span></div>
      <div class="payment-detail"><span class="payment-detail-label">Network</span><span class="payment-detail-val">Solana Mainnet</span></div>
      <div class="payment-detail"><span class="payment-detail-label">Balance</span><span class="payment-detail-val">${walletBalance ? walletBalance.toFixed(4) + ' SOL' : 'Loading...'}</span></div>
      <div class="payment-actions">
        <button class="cancel-btn" onclick="resetClaimModal()">Cancel</button>
        <button class="pay-btn" onclick="executeSolPayment('${tier}', ${usdAmount}, ${solAmount})">⚡ Pay ${solDisplay} SOL</button>
      </div>
    </div>
  `;
}

async function executeSolPayment(tier, usdAmount, solAmount) {
  const cardClass = tier === 'pro' ? '.pricing-card.pro' : tier === 'boost' ? '.pricing-card.boost' : '.community-card';
  const card = document.querySelector(cardClass);
  
  // Show processing state
  card.innerHTML = `
    <div class="payment-status">
      <div class="spinner-lg"></div>
      <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Processing Payment...</div>
      <div style="font-size:.78rem;color:var(--text-tertiary)">Approve the transaction in your wallet</div>
    </div>
  `;
  
  try {
    const provider = connectedWallet === 'phantom' ? getPhantomProvider() : getSolflareProvider();
    if (!provider) throw new Error('Wallet provider not found');
    
    // Build transaction using @solana/web3.js
    const { Connection, PublicKey, Transaction, SystemProgram, LAMPORTS_PER_SOL } = window.solanaWeb3;
    
    const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const fromPubkey = new PublicKey(walletPublicKey);
    const toPubkey = new PublicKey(RADAR_TREASURY);
    const lamports = Math.round(solAmount * LAMPORTS_PER_SOL);
    
    // Check balance
    if (walletBalance && walletBalance < solAmount + 0.005) {
      throw new Error(`Insufficient balance. You need ${(solAmount + 0.005).toFixed(4)} SOL (including fees), but only have ${walletBalance.toFixed(4)} SOL.`);
    }
    
    // Create transfer instruction
    const transaction = new Transaction().add(
      SystemProgram.transfer({
        fromPubkey,
        toPubkey,
        lamports
      })
    );
    
    // Get recent blockhash
    const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = fromPubkey;
    
    // Sign and send
    const signed = await provider.signAndSendTransaction(transaction);
    const signature = signed.signature || signed;
    
    // Wait for confirmation
    card.innerHTML = `
      <div class="payment-status">
        <div class="spinner-lg"></div>
        <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Confirming on-chain...</div>
        <div style="font-size:.78rem;color:var(--text-tertiary)">Waiting for Solana network confirmation</div>
      </div>
    `;
    
    await connection.confirmTransaction({ signature, blockhash, lastValidBlockHeight }, 'confirmed');
    
    // SUCCESS
    const tierEmoji = tier === 'pro' ? '🚀' : tier === 'boost' ? '⚡' : '💰';
    const tierLabel = tier === 'pro' ? 'Pro Profile Activated!' : tier === 'boost' ? 'Boost Activated!' : 'Contribution Received!';
    
    card.innerHTML = `
      <div class="payment-status">
        <div class="payment-success">✅</div>
        <div style="font-weight:800;font-size:1rem;margin-bottom:6px">${tierEmoji} ${tierLabel}</div>
        <div style="font-size:.78rem;color:var(--text-tertiary);line-height:1.5;margin-bottom:12px">${
          tier === 'pro' ? 'Your token now has a verified badge and full profile customization. Changes go live immediately.' :
          tier === 'boost' ? 'Your token will appear in Trending and Hot Picks for the next 7 days.' :
          'Thank you for contributing to this token\'s community fund!'
        }</div>
        <div style="font-family:var(--font-mono);font-size:.85rem;color:var(--accent);margin-bottom:8px">◎ ${solAmount.toFixed(4)} SOL paid</div>
        <div class="payment-tx">TX: <a href="https://solscan.io/tx/${signature}" target="_blank" rel="noopener">${String(signature).slice(0,16)}...${String(signature).slice(-16)}</a></div>
      </div>
    `;
    
    // Save claim to localStorage
    const claims = JSON.parse(localStorage.getItem('radar_claims') || '{}');
    claims[currentModalToken || 'unknown'] = {
      tier, usdAmount, solAmount, signature: String(signature), timestamp: Date.now()
    };
    localStorage.setItem('radar_claims', JSON.stringify(claims));
    
    // Refresh balance
    fetchSolBalance();
    
    showPaymentToast('✅ Payment Confirmed!', `${solAmount.toFixed(4)} SOL sent to RADAR Treasury`);
    
  } catch (err) {
    console.error('Payment failed:', err);
    const errMsg = err.message || 'Transaction was rejected or failed';
    
    card.innerHTML = `
      <div class="payment-status">
        <div class="payment-success">❌</div>
        <div style="font-weight:800;font-size:1rem;margin-bottom:6px;color:var(--red)">Payment Failed</div>
        <div style="font-size:.78rem;color:var(--text-tertiary);line-height:1.5;margin-bottom:16px">${errMsg}</div>
        <div class="payment-actions">
          <button class="cancel-btn" onclick="resetClaimModal()">Back</button>
          <button class="pay-btn" onclick="handlePayment('${tier}', ${usdAmount})">Retry</button>
        </div>
      </div>
    `;
  }
}

// =============================================
// COMMUNITY FUND — Custom amount contribution
// =============================================
function handleContribute() {
  if (!connectedWallet || !walletPublicKey) {
    showPaymentToast('🔗 Connect your wallet first', 'Connect Phantom or Solflare to contribute.');
    connectWallet();
    return;
  }
  
  if (!solPriceUSD || solPriceUSD <= 0) {
    showPaymentToast('⏳ Loading prices...', 'Please try again in a moment.');
    fetchTickerPrices();
    return;
  }
  
  const card = document.querySelector('.community-card');
  const origHTML = card.innerHTML;
  card.dataset.original = origHTML;
  
  card.innerHTML = `
    <div class="claim-form">
      <div style="font-weight:800;font-size:.95rem;margin-bottom:4px;color:var(--yellow)">💰 Contribute to Community Fund</div>
      <div style="font-size:.78rem;color:var(--text-tertiary);margin-bottom:16px">Any amount helps upgrade this token's profile. Goal: $49 (Pro)</div>
      <div class="claim-form-group">
        <div class="claim-form-label">Amount (USD)</div>
        <div class="contribute-input-wrap">
          <input class="claim-form-input" id="contributeAmount" type="number" min="0.5" step="0.5" value="5" placeholder="5.00" oninput="updateContribSol()">
          <span class="sol-equiv" id="contribSolEquiv">≈ ${(5 / solPriceUSD).toFixed(4)} SOL</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:16px">
        <button class="preset" onclick="setContribAmount(2)">$2</button>
        <button class="preset" onclick="setContribAmount(5)">$5</button>
        <button class="preset" onclick="setContribAmount(10)">$10</button>
        <button class="preset" onclick="setContribAmount(25)">$25</button>
      </div>
      <div class="payment-detail"><span class="payment-detail-label">From</span><span class="payment-detail-val addr">${walletPublicKey.slice(0,6)}...${walletPublicKey.slice(-6)}</span></div>
      <div class="payment-detail"><span class="payment-detail-label">To</span><span class="payment-detail-val">RADAR Treasury</span></div>
      <div class="payment-detail" style="border:none"><span class="payment-detail-label">Balance</span><span class="payment-detail-val">${walletBalance ? walletBalance.toFixed(4) + ' SOL' : '...'}</span></div>
      <div class="payment-actions" style="margin-top:12px">
        <button class="cancel-btn" onclick="restoreCommunityCard()">Cancel</button>
        <button class="pay-btn" onclick="executeContribution()">💰 Send Contribution</button>
      </div>
    </div>
  `;
}

function updateContribSol() {
  const val = parseFloat(document.getElementById('contributeAmount')?.value) || 0;
  const el = document.getElementById('contribSolEquiv');
  if (el && solPriceUSD > 0) el.textContent = `≈ ${(val / solPriceUSD).toFixed(4)} SOL`;
}

function setContribAmount(val) {
  const inp = document.getElementById('contributeAmount');
  if (inp) { inp.value = val; updateContribSol(); }
}

function restoreCommunityCard() {
  const card = document.querySelector('.community-card');
  if (card && card.dataset.original) card.innerHTML = card.dataset.original;
}

async function executeContribution() {
  const usdAmount = parseFloat(document.getElementById('contributeAmount')?.value) || 0;
  if (usdAmount < 0.1) {
    showPaymentToast('⚠️ Minimum $0.10', 'Please enter a valid amount.');
    return;
  }
  const solAmount = usdAmount / solPriceUSD;
  const card = document.querySelector('.community-card');
  
  // Reuse the same payment execution flow
  card.innerHTML = `
    <div class="payment-status">
      <div class="spinner-lg"></div>
      <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Processing Contribution...</div>
      <div style="font-size:.78rem;color:var(--text-tertiary)">Approve the transaction in your wallet</div>
    </div>
  `;
  
  try {
    const provider = connectedWallet === 'phantom' ? getPhantomProvider() : getSolflareProvider();
    if (!provider) throw new Error('Wallet provider not found');
    
    const { Connection, PublicKey, Transaction, SystemProgram, LAMPORTS_PER_SOL } = window.solanaWeb3;
    const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const fromPubkey = new PublicKey(walletPublicKey);
    const toPubkey = new PublicKey(RADAR_TREASURY);
    const lamports = Math.round(solAmount * LAMPORTS_PER_SOL);
    
    const transaction = new Transaction().add(
      SystemProgram.transfer({ fromPubkey, toPubkey, lamports })
    );
    
    const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
    transaction.recentBlockhash = blockhash;
    transaction.feePayer = fromPubkey;
    
    const signed = await provider.signAndSendTransaction(transaction);
    const signature = signed.signature || signed;
    
    card.innerHTML = `
      <div class="payment-status">
        <div class="spinner-lg"></div>
        <div style="font-weight:700;font-size:.9rem;margin-bottom:4px">Confirming on-chain...</div>
        <div style="font-size:.78rem;color:var(--text-tertiary)">Waiting for network confirmation</div>
      </div>
    `;
    
    await connection.confirmTransaction({ signature, blockhash, lastValidBlockHeight }, 'confirmed');
    
    // Update fund progress (simulate — in real backend this would query actual total)
    const funds = JSON.parse(localStorage.getItem('radar_fund') || '{"total": 33.40, "contributors": 12}');
    funds.total += usdAmount;
    funds.contributors += 1;
    localStorage.setItem('radar_fund', JSON.stringify(funds));
    const pct = Math.min(100, (funds.total / 49) * 100);
    
    card.innerHTML = `
      <div class="payment-status">
        <div class="payment-success">🎉</div>
        <div style="font-weight:800;font-size:1rem;margin-bottom:6px;color:var(--yellow)">Contribution Received!</div>
        <div style="font-size:.78rem;color:var(--text-tertiary);line-height:1.5;margin-bottom:12px">Thank you for supporting this token's community fund. $${funds.total.toFixed(2)} of $49 raised (${pct.toFixed(0)}%)!</div>
        <div style="font-family:var(--font-mono);font-size:.85rem;color:var(--accent);margin-bottom:8px">◎ ${solAmount.toFixed(4)} SOL contributed</div>
        <div class="payment-tx">TX: <a href="https://solscan.io/tx/${signature}" target="_blank" rel="noopener">${String(signature).slice(0,16)}...${String(signature).slice(-16)}</a></div>
      </div>
    `;
    
    fetchSolBalance();
    showPaymentToast('🎉 Contribution Sent!', `$${usdAmount.toFixed(2)} contributed to the community fund`);
    
  } catch (err) {
    console.error('Contribution failed:', err);
    card.innerHTML = `
      <div class="payment-status">
        <div class="payment-success">❌</div>
        <div style="font-weight:800;font-size:.9rem;margin-bottom:6px;color:var(--red)">Contribution Failed</div>
        <div style="font-size:.78rem;color:var(--text-tertiary);margin-bottom:16px">${err.message || 'Transaction rejected'}</div>
        <div class="payment-actions">
          <button class="cancel-btn" onclick="restoreCommunityCard()">Back</button>
          <button class="pay-btn" onclick="handleContribute()">Retry</button>
        </div>
      </div>
    `;
  }
}

// =============================================
// PAYMENT TOAST NOTIFICATION
// =============================================
function showPaymentToast(title, msg) {
  const existing = document.querySelector('.payment-toast');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'payment-toast';
  toast.style.cssText = 'position:fixed;top:80px;right:20px;z-index:3000;background:var(--bg-primary);border:1px solid var(--accent);border-radius:var(--radius-lg);padding:16px 20px;box-shadow:0 12px 40px rgba(0,219,164,0.15);animation:panelSlide .3s ease;max-width:320px;cursor:pointer';
  toast.innerHTML = `<div style="font-weight:700;font-size:.85rem;margin-bottom:4px">${title}</div><div style="font-size:.75rem;color:var(--text-tertiary)">${msg}</div>`;
  toast.onclick = () => toast.remove();
  document.body.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, 6000);
}

// Trade tabs
function setTab(el, type) {
  document.querySelectorAll('.t-tab').forEach(t => t.classList.remove('buy-active', 'sell-active'));
  el.classList.add(type === 'buy' ? 'buy-active' : 'sell-active');
  const btn = document.getElementById('execBtn');
  if (type === 'sell') { btn.textContent = '⚡ Quick Sell'; btn.className = 'exec-btn'; btn.style.background = 'var(--red)'; btn.style.color = 'white'; btn.style.boxShadow = '0 4px 20px rgba(255,77,106,0.2)'; }
  else { btn.textContent = '⚡ Quick Buy'; btn.className = 'exec-btn buy'; btn.style = ''; }
}

// =============================================
// NAV: Wire up filter tabs to switch data views
// =============================================
// =============================================
// ROUTER — Central view switcher for all nav tabs
// =============================================
let activeView = 'trending';
let watchlist = JSON.parse(localStorage.getItem('radar_watchlist') || '[]');
const contentEl = () => document.querySelector('.content');
const TABLE_HTML = `<div class="table-wrap"><table><thead><tr><th style="width:44px" title="RADAR Score">#</th><th>Token</th><th>Price</th><th>AI Score</th><th>Chart</th><th>5M</th><th>1H</th><th>6H</th><th>24H</th><th>Volume</th><th>Liquidity</th><th>MCAP</th><th>Safety</th><th></th></tr></thead><tbody id="tbody"></tbody></table></div>`;

function saveWatchlist() { localStorage.setItem('radar_watchlist', JSON.stringify(watchlist)); }
function isWatched(tick) { return watchlist.some(w => w.tick === tick); }
function toggleWatch(tick, name, imageUrl) {
  if (isWatched(tick)) { watchlist = watchlist.filter(w => w.tick !== tick); }
  else { watchlist.push({ tick, name, imageUrl, added: Date.now() }); }
  saveWatchlist();
  if (activeView === 'watchlist') switchView('watchlist');
  // Re-render table if in table view to update star
  if (['trending','new','gainers','losers'].includes(activeView)) render();
}

function switchView(view) {
  activeView = view;
  document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
  const navEl = document.querySelector(`.nav-item[data-view="${view}"]`);
  if (navEl) navEl.classList.add('active');

  const c = contentEl();
  switch (view) {
    case 'trending': case 'new': case 'gainers': case 'losers':
      c.innerHTML = TABLE_HTML;
      loadData(view === 'losers' ? 'gainers' : view);
      break;
    case 'whales':    renderWhaleView(c); break;
    case 'scanner':   renderScannerView(c); break;
    case 'multicharts': renderMultichartsView(c); break;
    case 'launchpad': c.innerHTML = TABLE_HTML; loadData('new'); break;
    case 'copytrade': renderCopyTradeView(c); break;
    case 'watchlist': renderWatchlistView(c); break;
    default: c.innerHTML = TABLE_HTML; loadData('trending');
  }
}

document.querySelectorAll('.nav-item[data-view]').forEach(n => {
  n.addEventListener('click', function() { switchView(this.dataset.view); });
});
document.querySelectorAll('.chip[data-chain]').forEach(c => c.addEventListener('click', function () {
  this.closest('.chip-group').querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
  this.classList.add('active');
  const chain = this.dataset.chain;
  currentNetwork = chain === 'all' ? 'all' : chain;
  isLoading = true;
  tokens = [];
  // Force table view for data reload
  if (['trending','new','gainers','losers','launchpad'].includes(activeView)) {
    switchView(activeView);
  } else {
    switchView('trending');
  }
}));
document.querySelectorAll('.chip:not([data-chain])').forEach(c => c.addEventListener('click', function () { this.closest('.chip-group').querySelectorAll('.chip').forEach(x => x.classList.remove('active')); this.classList.add('active'); }));
document.querySelectorAll('.tf-btn').forEach(b => b.addEventListener('click', function () { this.closest('.tf-group').querySelectorAll('.tf-btn').forEach(x => x.classList.remove('active')); this.classList.add('active'); }));

// =============================================
// SEARCH — Live search with contract address + token name
// =============================================
const searchInput = document.getElementById('searchInput');
const searchDropdown = document.getElementById('searchDropdown');
let searchTimeout = null;

const CHAIN_COLORS = { solana:'#9945ff', eth:'#627eea', base:'#2b6def', bsc:'#f0b90b', ton:'#0098ea' };
const CHAIN_LABELS = { solana:'SOL', eth:'ETH', base:'BASE', bsc:'BSC', ton:'TON' };

searchInput.addEventListener('input', function() {
  const q = this.value.trim();
  clearTimeout(searchTimeout);
  if (q.length < 2) { searchDropdown.classList.remove('active'); return; }
  searchDropdown.innerHTML = '<div class="search-loading"><div class="spinner" style="width:20px;height:20px;margin:0 auto 8px"></div>Searching...</div>';
  searchDropdown.classList.add('active');
  searchTimeout = setTimeout(() => executeSearch(q), 300);
});

searchInput.addEventListener('focus', function() {
  if (this.value.trim().length >= 2) searchDropdown.classList.add('active');
});

// Close dropdown on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-wrapper')) searchDropdown.classList.remove('active');
});

// ⌘K / Ctrl+K shortcut
document.addEventListener('keydown', function(e) {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); searchInput.focus(); searchInput.select(); }
  if (e.key === 'Escape') { searchDropdown.classList.remove('active'); searchInput.blur(); }
});

async function executeSearch(query) {
  const isAddress = query.length > 30 && /^[a-zA-Z0-9]+$/.test(query);
  
  try {
    let results = [];
    
    if (isAddress) {
      // Contract address search — try direct token lookup on current chain first, then all chains
      const chainsToSearch = currentNetwork === 'all' ? ALL_CHAINS : [currentNetwork, ...ALL_CHAINS.filter(c => c !== currentNetwork)];
      
      for (const net of chainsToSearch) {
        try {
          // Try as token address
          const url = `${GT_BASE}/networks/${CHAIN_CONFIG[net].gecko}/tokens/${query}?include=top_pools`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const json = await res.json();
          if (json?.data) {
            const t = json.data.attributes;
            const topPool = json.data.relationships?.top_pools?.data?.[0];
            let poolAddr = '';
            // Get pool address from included
            if (json.included) {
              const pool = json.included.find(i => i.type === 'pool');
              if (pool) poolAddr = pool.attributes?.address || pool.id?.split('_')[1] || '';
            }
            results.push({
              name: t.name || 'Unknown',
              symbol: t.symbol || '???',
              imageUrl: t.image_url || null,
              price: parseFloat(t.price_usd) || 0,
              priceChange: parseFloat(t.price_change_percentage?.h24) || 0,
              volume: parseFloat(t.volume_usd?.h24) || 0,
              address: t.address || query,
              poolAddress: poolAddr,
              network: net,
              mc: parseFloat(t.market_cap_usd) || parseFloat(t.fdv_usd) || 0,
            });
            break; // Found it — stop searching
          }
        } catch (e) { /* try next chain */ }
      }
      
      // Also try as pool address
      if (!results.length) {
        for (const net of chainsToSearch.slice(0, 3)) {
          try {
            const url = `${GT_BASE}/networks/${CHAIN_CONFIG[net].gecko}/pools/${query}?include=base_token`;
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            const json = await res.json();
            if (json?.data) {
              const a = json.data.attributes;
              const baseTokenData = json.included?.find(i => i.type === 'token')?.attributes;
              results.push({
                name: baseTokenData?.name || a.name?.split('/')[0] || 'Unknown',
                symbol: baseTokenData?.symbol || a.name?.split('/')[0] || '???',
                imageUrl: baseTokenData?.image_url || null,
                price: parseFloat(a.base_token_price_usd) || 0,
                priceChange: parseFloat(a.price_change_percentage?.h24) || 0,
                volume: parseFloat(a.volume_usd?.h24) || 0,
                address: baseTokenData?.address || query,
                poolAddress: a.address || query,
                network: net,
                mc: parseFloat(a.fdv_usd) || 0,
              });
              break;
            }
          } catch (e) {}
        }
      }
    } else {
      // Text search — use GeckoTerminal search endpoint
      const url = `${GT_BASE}/search?query=${encodeURIComponent(query)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const json = await res.json();
      
      if (json?.data?.attributes?.pools) {
        const pools = json.data.attributes.pools;
        const seenSymbols = new Set();
        
        pools.slice(0, 12).forEach(p => {
          const sym = p.tokens?.[0]?.symbol || p.name?.split('/')[0] || '';
          const key = sym + '_' + (p.network?.identifier || '');
          if (seenSymbols.has(key)) return;
          seenSymbols.add(key);
          
          const netId = p.network?.identifier || 'solana';
          // Map GeckoTerminal network identifiers to our IDs
          let netKey = 'solana';
          if (netId === 'eth' || netId === 'ethereum') netKey = 'eth';
          else if (netId === 'base') netKey = 'base';
          else if (netId === 'bsc' || netId === 'bsc_mainnet') netKey = 'bsc';
          else if (netId === 'ton') netKey = 'ton';
          else if (netId === 'solana') netKey = 'solana';
          else netKey = netId; // unknown chain
          
          results.push({
            name: p.tokens?.[0]?.name || p.name?.split('/')[0] || 'Unknown',
            symbol: p.tokens?.[0]?.symbol || sym || '???',
            imageUrl: p.tokens?.[0]?.image_url || null,
            price: parseFloat(p.price_in_usd) || 0,
            priceChange: parseFloat(p.price_percentage_change?.h24) || 0,
            volume: parseFloat(p.volume_in_usd) || 0,
            address: p.tokens?.[0]?.address || '',
            poolAddress: p.address || '',
            network: netKey,
            mc: 0,
          });
        });
      }
    }
    
    // Also search within loaded tokens (instant, free)
    const localMatches = tokens.filter(t =>
      t.tick.toLowerCase().includes(query.toLowerCase()) ||
      t.name.toLowerCase().includes(query.toLowerCase()) ||
      (t.baseAddr && t.baseAddr.toLowerCase() === query.toLowerCase())
    ).slice(0, 5).map(t => ({
      name: t.name, symbol: t.tick, imageUrl: t.imageUrl,
      price: t.p, priceChange: t.h24, volume: t.volRaw,
      address: t.baseAddr, poolAddress: t.poolAddress,
      network: t.network || currentNetwork, mc: t.mcRaw,
      isLocal: true, localIndex: tokens.indexOf(t),
    }));
    
    renderSearchResults(localMatches, results, query);
    
  } catch (err) {
    console.error('Search failed:', err);
    searchDropdown.innerHTML = '<div class="search-empty">⚠️ Search failed — try again</div>';
  }
}

function renderSearchResults(local, remote, query) {
  let html = '';
  
  if (local.length) {
    html += '<div class="search-dropdown-header">📊 Currently Loaded</div>';
    html += local.map(r => searchResultHTML(r, true)).join('');
  }
  
  // Filter out remote results already in local
  const localAddrs = new Set(local.map(l => l.address?.toLowerCase()).filter(Boolean));
  const uniqueRemote = remote.filter(r => !localAddrs.has(r.address?.toLowerCase()));
  
  if (uniqueRemote.length) {
    html += `<div class="search-dropdown-header">🌐 ${query.length > 30 ? 'Contract Match' : 'All Networks'}</div>`;
    html += uniqueRemote.map(r => searchResultHTML(r, false)).join('');
  }
  
  if (!local.length && !uniqueRemote.length) {
    html = '<div class="search-empty">No results found for "' + query.slice(0, 30) + '"</div>';
  }
  
  searchDropdown.innerHTML = html;
}

function searchResultHTML(r, isLocal) {
  const cc = CHAIN_COLORS[r.network] || '#9945ff';
  const cl = CHAIN_LABELS[r.network] || r.network?.toUpperCase() || '?';
  const g = gradients[Math.abs(hashStr(r.symbol || '')) % gradients.length];
  const chgClass = r.priceChange >= 0 ? 'up' : 'down';
  const chgColor = r.priceChange >= 0 ? 'var(--accent)' : 'var(--red)';
  
  const onclick = isLocal && r.localIndex !== undefined
    ? `onclick="searchDropdown.classList.remove('active');openModal(${r.localIndex})"`
    : `onclick="searchDropdown.classList.remove('active');loadSearchedToken('${r.network}','${r.poolAddress}','${r.address}')"`;
  
  return `
    <div class="search-result" ${onclick}>
      ${r.imageUrl
        ? `<img class="search-result-img" src="${r.imageUrl}" onerror="this.className='search-result-fallback';this.style.background='linear-gradient(135deg,${g[0]},${g[1]})';this.textContent='${(r.symbol||'?')[0]}'">`
        : `<div class="search-result-fallback" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${(r.symbol||'?')[0]}</div>`
      }
      <div class="search-result-info">
        <div class="search-result-name">${r.name} <span class="search-chain-tag" style="background:${cc}22;color:${cc}">${cl}</span></div>
        <div class="search-result-sub">${r.symbol}${r.address ? ' · ' + r.address.slice(0,6) + '...' + r.address.slice(-4) : ''}</div>
      </div>
      <div class="search-result-right">
        ${r.price ? `<div class="search-result-price">${fmtPrice(r.price)}</div>` : ''}
        ${r.priceChange ? `<div class="search-result-chg" style="color:${chgColor}">${r.priceChange >= 0 ? '+' : ''}${r.priceChange.toFixed(1)}%</div>` : ''}
      </div>
    </div>`;
}

function hashStr(s) { let h = 0; for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i); return h; }

// Load a token found via search into the table view
async function loadSearchedToken(network, poolAddress, tokenAddress) {
  // Switch to that chain
  if (network && CHAIN_CONFIG[network]) {
    currentNetwork = network;
    document.querySelectorAll('.chip[data-chain]').forEach(c => c.classList.remove('active'));
    const matchChip = document.querySelector(`.chip[data-chain="${network}"]`);
    if (matchChip) matchChip.classList.add('active');
    else document.querySelector('.chip[data-chain="all"]').classList.add('active');
  }
  
  // Try to fetch the pool data to inject into table
  if (poolAddress) {
    try {
      const net = CHAIN_CONFIG[network]?.gecko || network;
      const url = `${GT_BASE}/networks/${net}/pools/${poolAddress}?include=base_token,quote_token`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const json = await res.json();
      if (json?.data) {
        // Wrap in array format parsePools expects
        const poolData = { data: [json.data], included: json.included || [] };
        const parsed = parsePools(poolData, network);
        if (parsed.length) {
          // Load trending for context, but put this token first
          isLoading = true;
          switchView('trending');
          const trending = await fetchTrending(network);
          if (trending) {
            // Remove dupe and prepend
            const filtered = trending.filter(t => t.poolAddress !== parsed[0].poolAddress);
            tokens = [...parsed, ...filtered];
            rankTokens(tokens);
            isLoading = false;
            render();
            renderHeat(); renderDynamicFeed(); renderWallets();
            // Auto-open the modal for the searched token
            setTimeout(() => openModal(0), 400);
            return;
          }
        }
      }
    } catch (e) { console.error('Pool fetch failed:', e); }
  }
  
  // Fallback — just load the chain's trending
  isLoading = true;
  switchView('trending');
}

// =============================================
// TABLE RENDER — now includes star + losers sort
// =============================================
const _baseRender = render;
render = function() {
  if (isLoading) {
    const tb = document.getElementById('tbody');
    if (tb) tb.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:60px;color:var(--text-muted)"><div class="chart-loading" style="position:static;background:none"><div class="spinner"></div>Fetching live on-chain data...</div></td></tr>';
    return;
  }
  let list = [...tokens];
  // Sort losers by biggest negative 24h change
  if (activeView === 'losers') {
    list.sort((a, b) => a.h24 - b.h24);
    list.forEach((t, i) => t.rank = i + 1);
  }
  // Launchpad: filter only < 24h old
  if (activeView === 'launchpad') {
    list = list.filter(t => t.ageH <= 24);
    list.forEach((t, i) => t.rank = i + 1);
  }
  const tb = document.getElementById('tbody');
  if (!tb) return;
  tb.innerHTML = list.map((t, i) => `
    <tr onclick="openModal(${tokens.indexOf(t)})" style="animation-delay:${i * 0.04}s">
      <td><span class="rank ${t.rank <= 3 ? 'gold' : ''}">${t.rank}</span></td>
      <td><div class="tk">${tokenImgHTML(t)}<div><div class="tk-name">${t.name}${t.verified ? ' <span class="verified-badge">✓</span>' : ''}<span class="chain-dot" style="background:${t.cc}"></span>${t.ageH <= 6 ? '<span class="new-tag">NEW</span>' : ''}</div><div class="tk-sub">${t.tick}/${t.pair} · ${t.age}</div></div></div></td>
      <td class="price">${fmtPrice(t.p)}</td>
      <td>${aiHTML(t.ai)}</td>
      <td>${sparkSVG(t)}</td>
      <td>${chg(t.m5)}</td>
      <td>${chg(t.h1)}</td>
      <td>${chg(t.h6)}</td>
      <td>${chg(t.h24)}</td>
      <td class="muted">$${fmtVol(t.volRaw)}</td>
      <td class="muted">$${fmtVol(t.liqRaw)}</td>
      <td class="muted">$${fmtMc(t.mcRaw)}</td>
      <td>${safeHTML(t.safe)}</td>
      <td><div class="qt"><button class="star-btn ${isWatched(t.tick)?'active':''}" onclick="event.stopPropagation();toggleWatch('${t.tick}','${t.name.replace(/'/g,"\\'")}','${t.imageUrl||''}')" title="Watchlist">${isWatched(t.tick)?'★':'☆'}</button><button class="qt-btn qt-buy" onclick="event.stopPropagation()">BUY</button></div></td>
    </tr>
  `).join('');
};

// =============================================
// VIEW: WHALE WATCH — Large transaction monitor
// =============================================
function renderWhaleView(c) {
  if (!tokens.length) {
    c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted)"><div class="spinner" style="margin:0 auto 12px"></div>Loading data...</div>';
    setTimeout(() => renderWhaleView(c), 1500);
    return;
  }
  const whaleIcons = ['🐋','🦈','🐳','🦑','🏦','💎','🔱','👑'];
  const whaleNames = ['BlueWhale.sol','DarkShark','OceanKing','DeepDiver','InstitutionX','DiamondHand','TridentFund','AlphaKing'];
  // Generate realistic whale moves from actual trending tokens
  const moves = [];
  tokens.slice(0, 15).forEach((t, i) => {
    const isBuy = t.h1 > 0 || Math.random() > 0.4;
    const bigAmt = (t.volRaw * (0.02 + Math.random() * 0.08));
    const addr = t.baseAddr || ('XXXX' + Math.random().toString(36).slice(2, 8));
    moves.push({
      icon: whaleIcons[i % whaleIcons.length],
      whale: whaleNames[i % whaleNames.length],
      addr: addr.slice(0,4) + '...' + addr.slice(-4),
      token: t, isBuy,
      amount: bigAmt,
      time: Math.floor(Math.random() * 58 + 1) + 'm ago',
      winRate: (55 + Math.random() * 35).toFixed(0),
      totalPnl: '+$' + fmtVol(Math.random() * 5000000 + 100000),
    });
  });
  moves.sort((a, b) => b.amount - a.amount);

  c.innerHTML = `
    <div class="view-header">
      <div><div class="view-header-title">🐋 Whale Watch — Smart Money Tracker</div><div class="view-header-sub">Large transactions detected on trending Solana tokens · Auto-refreshes</div></div>
    </div>
    <div class="card-view" id="whaleCards">
      ${moves.map(m => `
        <div class="data-card" onclick="openModal(${tokens.indexOf(m.token)})">
          <div class="data-card-row">
            <div class="data-card-icon" style="background:${m.isBuy ? 'var(--accent-dim)' : 'var(--red-dim)'};border:1px solid ${m.isBuy ? 'rgba(0,219,164,0.2)' : 'rgba(255,77,106,0.2)'}">${m.icon}</div>
            <div class="data-card-info">
              <div class="data-card-title">${m.whale} <span style="font-family:var(--font-mono);font-size:.7rem;color:var(--text-muted)">${m.addr}</span></div>
              <div class="data-card-sub">${m.time} · Win Rate: ${m.winRate}% · Total PnL: ${m.totalPnl}</div>
            </div>
            <div class="data-card-right">
              <div class="whale-amount ${m.isBuy ? 'buy' : 'sell'}">${m.isBuy ? '+ ' : '- '}$${fmtVol(m.amount)}</div>
              <div class="data-card-meta">${m.isBuy ? 'BOUGHT' : 'SOLD'} ${m.token.tick}</div>
            </div>
          </div>
          <div class="data-card-tags">
            <span class="data-card-tag ${m.isBuy ? 'buy' : 'sell'}">${m.isBuy ? '🟢 BUY' : '🔴 SELL'}</span>
            <span class="data-card-tag info">${m.token.tick}/${m.token.pair}</span>
            <span class="data-card-tag info">Vol: $${fmtVol(m.token.volRaw)}</span>
            ${parseFloat(m.winRate) > 80 ? '<span class="data-card-tag new">🏆 Top Trader</span>' : ''}
          </div>
        </div>
      `).join('')}
    </div>`;
}

// =============================================
// VIEW: AI SCANNER — Safety analysis dashboard
// =============================================
function renderScannerView(c) {
  if (!tokens.length) {
    c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted)"><div class="spinner" style="margin:0 auto 12px"></div>Scanning tokens...</div>';
    setTimeout(() => renderScannerView(c), 1500);
    return;
  }
  const sorted = [...tokens].sort((a, b) => b.ai - a.ai);
  
  c.innerHTML = `
    <div class="view-header">
      <div><div class="view-header-title">🧠 AI Safety Scanner</div><div class="view-header-sub">Automated safety analysis · Liquidity, volume authenticity, holder distribution, contract risk</div></div>
    </div>
    <div class="card-view">
      ${sorted.map((t, i) => {
        const rugProb = Math.max(2, 100 - t.ai);
        const liqScore = Math.min(100, (t.liqRaw / 500000) * 100);
        const volScore = Math.min(100, (t.volRaw / 2000000) * 100);
        const ageScore = Math.min(100, (t.ageH / 168) * 100);
        const g = gradients[i % gradients.length];
        return `
        <div class="data-card" onclick="openModal(${tokens.indexOf(t)})">
          <div class="data-card-row">
            <div style="position:relative">
              ${t.imageUrl ? `<img src="${t.imageUrl}" width="44" height="44" style="border-radius:var(--radius-sm);border:1px solid var(--border-default)" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="data-card-icon" style="display:none;background:linear-gradient(135deg,${g[0]},${g[1]})">${t.tick[0]}</div>` : `<div class="data-card-icon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${t.tick[0]}</div>`}
            </div>
            <div class="data-card-info">
              <div class="data-card-title">${t.name} ${t.verified ? '<span class="verified-badge">✓</span>' : ''} <span style="font-size:.75rem;color:var(--text-muted)">${t.tick}</span></div>
              <div class="data-card-sub">$${fmtVol(t.volRaw)} vol · $${fmtVol(t.liqRaw)} liq · ${t.age} old · ${(t.txns24||0).toLocaleString()} txns</div>
            </div>
            <div class="data-card-right">
              <div class="scanner-metric-val" style="font-size:1.2rem;color:${t.ai >= 70 ? 'var(--accent)' : t.ai >= 40 ? 'var(--orange)' : 'var(--red)'}">${t.ai}</div>
              <div class="data-card-meta">${t.safe === 'safe' ? '✓ SAFE' : t.safe === 'warn' ? '⚠ CAUTION' : '☠ DANGER'}</div>
            </div>
          </div>
          <div class="scanner-bar"><div class="scanner-fill" style="width:${t.ai}%;background:${t.ai >= 70 ? 'var(--accent)' : t.ai >= 40 ? 'var(--orange)' : 'var(--red)'}"></div></div>
          <div class="scanner-metrics">
            <div class="scanner-metric"><div class="scanner-metric-val" style="color:${liqScore > 50 ? 'var(--accent)' : 'var(--orange)'}">${liqScore.toFixed(0)}</div><div class="scanner-metric-label">Liquidity</div></div>
            <div class="scanner-metric"><div class="scanner-metric-val" style="color:${volScore > 50 ? 'var(--accent)' : 'var(--orange)'}">${volScore.toFixed(0)}</div><div class="scanner-metric-label">Volume</div></div>
            <div class="scanner-metric"><div class="scanner-metric-val" style="color:${ageScore > 30 ? 'var(--accent)' : 'var(--red)'}">${ageScore.toFixed(0)}</div><div class="scanner-metric-label">Maturity</div></div>
          </div>
          <div class="data-card-tags">
            ${rugProb <= 15 ? '<span class="data-card-tag buy">🛡️ Low Rug Risk</span>' : rugProb <= 50 ? '<span class="data-card-tag warn">⚠️ Medium Risk</span>' : '<span class="data-card-tag sell">☠️ High Risk</span>'}
            ${t.liqRaw > 200000 ? '<span class="data-card-tag buy">💧 Deep Liquidity</span>' : ''}
            ${t.buyers24 > 500 ? '<span class="data-card-tag buy">👥 Many Buyers</span>' : ''}
            ${t.ageH < 6 ? '<span class="data-card-tag new">🆕 Very New</span>' : ''}
            ${t.buyRatio > 0.6 ? '<span class="data-card-tag buy">📈 Buy Pressure</span>' : t.buyRatio < 0.35 ? '<span class="data-card-tag sell">📉 Sell Pressure</span>' : ''}
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

// =============================================
// VIEW: MULTICHARTS — Grid of live charts
// =============================================
let multichartsTokens = [];
function renderMultichartsView(c) {
  if (!tokens.length) {
    c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted)"><div class="spinner" style="margin:0 auto 12px"></div>Loading charts...</div>';
    setTimeout(() => renderMultichartsView(c), 1500);
    return;
  }
  if (!multichartsTokens.length) multichartsTokens = tokens.slice(0, 6).map(t => t.poolAddress);
  const active = tokens.filter(t => multichartsTokens.includes(t.poolAddress)).slice(0, 6);
  // Pad with top tokens if not enough
  while (active.length < 4) {
    const next = tokens.find(t => !active.includes(t));
    if (next) active.push(next); else break;
  }
  const gridClass = active.length > 4 ? 'charts-2x3' : 'charts-2x2';

  c.innerHTML = `
    <div class="view-header">
      <div><div class="view-header-title">📊 Multicharts</div><div class="view-header-sub">Live charts for ${active.length} tokens · Click any token row to add</div></div>
      <div class="view-header-actions">
        <button class="view-header-btn" onclick="multichartsTokens=tokens.slice(0,4).map(t=>t.poolAddress);renderMultichartsView(contentEl())">2×2</button>
        <button class="view-header-btn" onclick="multichartsTokens=tokens.slice(0,6).map(t=>t.poolAddress);renderMultichartsView(contentEl())">2×3</button>
      </div>
    </div>
    <div class="view-grid ${gridClass}">
      ${active.map(t => {
        const mcNet = (t.network && CHAIN_CONFIG[t.network]) ? CHAIN_CONFIG[t.network].gecko : 'solana';
        const embedUrl = `https://www.geckoterminal.com/${mcNet}/pools/${t.poolAddress}?embed=1&info=0&swaps=0&grayscale=0&light_chart=0`;
        return `
        <div class="chart-cell">
          <div class="chart-cell-header">
            <span class="chart-cell-token">${tokenImgHTML(t, 22)} ${t.tick} <span class="chart-cell-chg ${t.h24 >= 0 ? 'up' : 'down'}" style="color:${t.h24 >= 0 ? 'var(--accent)' : 'var(--red)'}">${t.h24 >= 0 ? '+' : ''}${t.h24.toFixed(1)}%</span></span>
            <button class="chart-cell-close" onclick="multichartsTokens=multichartsTokens.filter(p=>p!=='${t.poolAddress}');renderMultichartsView(contentEl())" title="Remove">✕</button>
          </div>
          <iframe src="${embedUrl}" loading="eager" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
        </div>`;
      }).join('')}
    </div>`;
}

// =============================================
// VIEW: LAUNCHPAD — newest launches
// Uses same table but filtered to < 24h old tokens
// (handled in render() with activeView check)
// =============================================

// =============================================
// VIEW: COPY TRADE — Top trader profiles
// =============================================
function renderCopyTradeView(c) {
  if (!tokens.length) {
    c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted)"><div class="spinner" style="margin:0 auto 12px"></div>Loading traders...</div>';
    setTimeout(() => renderCopyTradeView(c), 1500);
    return;
  }
  
  // Generate realistic trader profiles from actual token data
  const traders = [
    { name: 'WhaleMaster', icon: '🐋', bg: 'linear-gradient(135deg,#9945ff,#14F195)', pnl: '+$2.4M', winRate: 87, trades30d: 142, avgHold: '4.2h', style: 'Momentum' },
    { name: 'DeFi_Shark', icon: '🦈', bg: 'linear-gradient(135deg,#ff4d6a,#ff9a56)', pnl: '+$890K', winRate: 73, trades30d: 289, avgHold: '18m', style: 'Scalper' },
    { name: 'AlphaHunter', icon: '🎯', bg: 'linear-gradient(135deg,#4da6ff,#a78bfa)', pnl: '+$1.7M', winRate: 81, trades30d: 67, avgHold: '2.1d', style: 'Swing' },
    { name: 'NightOwl', icon: '🦉', bg: 'linear-gradient(135deg,#00dba4,#4da6ff)', pnl: '+$560K', winRate: 69, trades30d: 201, avgHold: '45m', style: 'Sniper' },
    { name: 'DiamondPaws', icon: '💎', bg: 'linear-gradient(135deg,#ffd166,#ff6b6b)', pnl: '+$3.1M', winRate: 91, trades30d: 34, avgHold: '6.8d', style: 'Holder' },
    { name: 'GigaBrain', icon: '🧠', bg: 'linear-gradient(135deg,#a78bfa,#ff4d6a)', pnl: '+$1.2M', winRate: 78, trades30d: 156, avgHold: '1.5h', style: 'AI-Assisted' },
  ];

  c.innerHTML = `
    <div class="view-header">
      <div><div class="view-header-title">👥 Copy Trade — Follow Top Traders</div><div class="view-header-sub">Mirror the moves of Solana's most profitable wallets · Automated execution</div></div>
    </div>
    <div class="card-view copytrade-grid">
      ${traders.map((tr, ti) => {
        const addr = '0x' + Array.from({length:8}, () => Math.floor(Math.random()*16).toString(16)).join('');
        const recentTrades = tokens.slice(ti * 2, ti * 2 + 3);
        return `
        <div class="trader-card">
          <div class="trader-header">
            <div class="trader-avi" style="background:${tr.bg}">${tr.icon}</div>
            <div style="flex:1">
              <div class="trader-name">${tr.name} ${tr.winRate > 80 ? '<span style="font-size:.65rem;padding:2px 6px;border-radius:6px;background:var(--accent-dim);color:var(--accent);font-weight:700">🏆 TOP</span>' : ''}</div>
              <div class="trader-addr">${addr}...${addr.slice(-4)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:var(--font-mono);font-weight:800;color:var(--accent);font-size:1rem">${tr.pnl}</div>
              <div style="font-size:.65rem;color:var(--text-muted)">30d PnL</div>
            </div>
          </div>
          <div class="trader-stats">
            <div class="trader-stat"><div class="trader-stat-val" style="color:var(--accent)">${tr.winRate}%</div><div class="trader-stat-label">Win Rate</div></div>
            <div class="trader-stat"><div class="trader-stat-val">${tr.trades30d}</div><div class="trader-stat-label">Trades</div></div>
            <div class="trader-stat"><div class="trader-stat-val">${tr.avgHold}</div><div class="trader-stat-label">Avg Hold</div></div>
            <div class="trader-stat"><div class="trader-stat-val" style="color:var(--blue)">${tr.style}</div><div class="trader-stat-label">Style</div></div>
          </div>
          <div style="font-size:.7rem;color:var(--text-muted);margin-bottom:6px;font-weight:600">RECENT TRADES</div>
          <div class="trader-trades">
            ${recentTrades.map(t => {
              const isBuy = Math.random() > 0.35;
              return `<span class="trader-trade ${isBuy ? 'buy' : 'sell'}" style="background:${isBuy ? 'var(--accent-dim)' : 'var(--red-dim)'}; color:${isBuy ? 'var(--accent)' : 'var(--red)'}">${isBuy ? '↑' : '↓'} ${t.tick}</span>`;
            }).join('')}
          </div>
          <button class="copy-btn" onclick="event.stopPropagation();this.textContent='✓ Following — Alerts ON';this.style.background='var(--accent)';this.style.color='var(--bg-deep)'">📋 Copy This Trader</button>
        </div>`;
      }).join('')}
    </div>`;
}

// =============================================
// VIEW: WATCHLIST — Saved tokens
// =============================================
function renderWatchlistView(c) {
  if (!watchlist.length) {
    c.innerHTML = `
      <div class="view-header">
        <div><div class="view-header-title">⭐ Watchlist</div><div class="view-header-sub">Your saved tokens · Click ☆ on any token to add</div></div>
      </div>
      <div class="watchlist-empty">
        <div class="watchlist-empty-icon">⭐</div>
        <div style="font-size:1rem;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Your watchlist is empty</div>
        <div class="watchlist-hint">Star any token from the Trending, New Pairs, or Gainers tabs to add it here. You can also star tokens from the token detail modal.</div>
        <button class="alert-add-btn" style="margin-top:20px;max-width:200px;margin-left:auto;margin-right:auto" onclick="switchView('trending')">Browse Trending →</button>
      </div>`;
    return;
  }

  // Match watchlist ticks to current token data
  const matched = watchlist.map(w => {
    const live = tokens.find(t => t.tick === w.tick);
    return { ...w, live };
  });

  c.innerHTML = `
    <div class="view-header">
      <div><div class="view-header-title">⭐ Watchlist <span style="font-size:.8rem;font-weight:400;color:var(--text-muted)">(${watchlist.length})</span></div><div class="view-header-sub">Your saved tokens · Live prices auto-update</div></div>
      <div class="view-header-actions">
        <button class="view-header-btn" onclick="if(confirm('Clear entire watchlist?')){watchlist=[];saveWatchlist();renderWatchlistView(contentEl())}">🗑 Clear All</button>
      </div>
    </div>
    <div class="card-view">
      ${matched.map(w => {
        const t = w.live;
        const g = gradients[Math.floor(Math.random() * gradients.length)];
        if (t) {
          return `
          <div class="data-card" onclick="openModal(${tokens.indexOf(t)})">
            <div class="data-card-row">
              ${t.imageUrl ? `<img src="${t.imageUrl}" width="44" height="44" style="border-radius:var(--radius-sm);border:1px solid var(--border-default)" onerror="this.style.display='none'">` : `<div class="data-card-icon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${t.tick[0]}</div>`}
              <div class="data-card-info">
                <div class="data-card-title">${t.name} ${t.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                <div class="data-card-sub">${t.tick}/${t.pair} · Rank #${t.rank} · ${t.age}</div>
              </div>
              <div class="data-card-right" style="display:flex;align-items:center;gap:16px">
                <div>
                  <div class="data-card-val" style="color:var(--text-primary)">${fmtPrice(t.p)}</div>
                  <div class="data-card-meta ${t.h24 >= 0 ? 'up' : 'down'}" style="color:${t.h24 >= 0 ? 'var(--accent)' : 'var(--red)'}; font-weight:600">${t.h24 >= 0 ? '+' : ''}${t.h24.toFixed(2)}%</div>
                </div>
                <div style="text-align:center">
                  <div style="font-family:var(--font-mono);font-size:.8rem;color:var(--text-tertiary)">$${fmtVol(t.volRaw)}</div>
                  <div class="data-card-meta">Volume</div>
                </div>
                <button class="star-btn active" onclick="event.stopPropagation();toggleWatch('${t.tick}','${t.name.replace(/'/g,"\\'")}','${t.imageUrl||''}')" title="Remove">★</button>
              </div>
            </div>
            <div class="data-card-tags">
              ${safeHTML(t.safe)}
              <span class="data-card-tag info">AI: ${t.ai}</span>
              <span class="data-card-tag info">Liq: $${fmtVol(t.liqRaw)}</span>
              <span class="data-card-tag info">MC: $${fmtMc(t.mcRaw)}</span>
            </div>
          </div>`;
        }
        // Token not in current data — show minimal info
        return `
          <div class="data-card">
            <div class="data-card-row">
              ${w.imageUrl ? `<img src="${w.imageUrl}" width="44" height="44" style="border-radius:var(--radius-sm);border:1px solid var(--border-default)" onerror="this.style.display='none'">` : `<div class="data-card-icon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${(w.tick||'?')[0]}</div>`}
              <div class="data-card-info">
                <div class="data-card-title">${w.name || w.tick}</div>
                <div class="data-card-sub">${w.tick} · Not in current trending</div>
              </div>
              <button class="star-btn active" onclick="event.stopPropagation();toggleWatch('${w.tick}','${(w.name||'').replace(/'/g,"\\'")}','${w.imageUrl||''}')" title="Remove">★</button>
            </div>
          </div>`;
      }).join('')}
    </div>`;
}

// =============================================
// WALLET CONNECTION (Phantom / Solflare)
// =============================================
let connectedWallet = null;
let walletPublicKey = null;
let walletBalance = null;
let portfolioTokens = [];
let solPriceUSD = 0;
const RADAR_TREASURY = '4WsUY7F2VQJ7ahB1Wo44pP82M4pCJLyyLdgT9JeYSerj';

function getPhantomProvider() {
  if ('phantom' in window) return window.phantom?.solana;
  if ('solana' in window && window.solana?.isPhantom) return window.solana;
  return null;
}

function getSolflareProvider() {
  if ('solflare' in window) return window.solflare;
  return null;
}

async function connectWallet() {
  // If already connected, show wallet info
  if (connectedWallet && walletPublicKey) {
    openWalletInfo();
    return;
  }
  // Show wallet selection
  openWalletPanel();
}

function openWalletPanel() {
  const phantom = getPhantomProvider();
  const solflare = getSolflareProvider();
  const body = document.getElementById('walletPanelBody');
  document.getElementById('walletPanelTitle').textContent = 'Connect Wallet';
  
  body.innerHTML = `
    <div style="margin-bottom:16px;color:var(--text-tertiary);font-size:.8rem">Choose your preferred wallet to connect to RADAR</div>
    <div class="wallet-option" onclick="connectPhantom()">
      <img src="https://raw.githubusercontent.com/nicnocquee/cryptocurrency-icons/master/128/color/sol.png" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 40%22><rect fill=%22%239945FF%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2228%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22>👻</text></svg>'" alt="Phantom">
      <div class="wallet-option-info">
        <div class="wallet-option-name">Phantom</div>
        <div class="wallet-option-desc">The most popular Solana wallet</div>
      </div>
      <span class="wallet-option-tag ${phantom ? 'detected' : 'not-detected'}">${phantom ? '✓ Detected' : 'Not Installed'}</span>
    </div>
    <div class="wallet-option" onclick="connectSolflare()">
      <img src="https://raw.githubusercontent.com/nicnocquee/cryptocurrency-icons/master/128/color/sol.png" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 40%22><rect fill=%22%23FC7227%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2228%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22>🔆</text></svg>'" alt="Solflare">
      <div class="wallet-option-info">
        <div class="wallet-option-name">Solflare</div>
        <div class="wallet-option-desc">Full-featured Solana wallet</div>
      </div>
      <span class="wallet-option-tag ${solflare ? 'detected' : 'not-detected'}">${solflare ? '✓ Detected' : 'Not Installed'}</span>
    </div>
    <div style="margin-top:24px;padding:14px;border-radius:var(--radius-md);background:var(--bg-card);border:1px solid var(--border-subtle)">
      <div style="font-size:.75rem;color:var(--text-tertiary);text-align:center">Don't have a wallet? <a href="https://phantom.app/download" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600">Download Phantom →</a></div>
    </div>
  `;
  document.getElementById('walletPanel').classList.add('active');
}

async function connectPhantom() {
  const provider = getPhantomProvider();
  if (!provider) {
    window.open('https://phantom.app/download', '_blank');
    return;
  }
  try {
    const resp = await provider.connect();
    walletPublicKey = resp.publicKey.toString();
    connectedWallet = 'phantom';
    onWalletConnected();
  } catch (err) {
    console.error('Phantom connect error:', err);
  }
}

async function connectSolflare() {
  const provider = getSolflareProvider();
  if (!provider) {
    window.open('https://solflare.com/download', '_blank');
    return;
  }
  try {
    await provider.connect();
    walletPublicKey = provider.publicKey.toString();
    connectedWallet = 'solflare';
    onWalletConnected();
  } catch (err) {
    console.error('Solflare connect error:', err);
  }
}

function onWalletConnected() {
  // Update header button
  const btn = document.getElementById('walletBtn');
  const short = walletPublicKey.slice(0, 4) + '...' + walletPublicKey.slice(-4);
  btn.innerHTML = `<span class="wallet-addr-short">${short}</span>`;
  btn.classList.remove('glow');
  btn.classList.add('connected');
  
  // Show wallet info panel
  openWalletInfo();
  
  // Fetch SOL balance
  fetchSolBalance();
  
  // Fetch portfolio
  fetchPortfolio();
}

async function fetchSolBalance() {
  try {
    const rpc = 'https://api.mainnet-beta.solana.com';
    const res = await fetch(rpc, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0', id: 1,
        method: 'getBalance',
        params: [walletPublicKey]
      })
    });
    const data = await res.json();
    walletBalance = (data.result?.value || 0) / 1e9; // lamports to SOL
    // Update wallet info if panel is open
    const balEl = document.getElementById('walletBalanceDisplay');
    if (balEl) balEl.textContent = walletBalance.toFixed(4) + ' SOL';
  } catch (err) {
    console.error('Balance fetch failed:', err);
  }
}

function openWalletInfo() {
  const body = document.getElementById('walletPanelBody');
  document.getElementById('walletPanelTitle').textContent = connectedWallet === 'phantom' ? '👻 Phantom' : '🔆 Solflare';
  const short = walletPublicKey.slice(0, 4) + '...' + walletPublicKey.slice(-4);
  
  body.innerHTML = `
    <div class="wallet-info-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--accent)"></div>
        <span style="font-size:.8rem;color:var(--accent);font-weight:600">Connected</span>
      </div>
      <div class="wallet-addr-full">${walletPublicKey}</div>
      <div class="wallet-balance" id="walletBalanceDisplay">${walletBalance !== null ? walletBalance.toFixed(4) + ' SOL' : 'Loading...'}</div>
      <div class="wallet-balance-label">SOL Balance</div>
      <div class="wallet-actions">
        <button class="wallet-action-btn copy" onclick="copyAddress()">📋 Copy Address</button>
        <button class="wallet-action-btn disconnect" onclick="disconnectWallet()">⏏ Disconnect</button>
      </div>
    </div>
    <div style="font-size:.75rem;color:var(--text-muted);text-align:center;padding:8px">View full portfolio in the Portfolio tab</div>
  `;
  document.getElementById('walletPanel').classList.add('active');
}

function copyAddress() {
  if (!walletPublicKey) return;
  navigator.clipboard.writeText(walletPublicKey).then(() => {
    const btn = event.target;
    btn.textContent = '✓ Copied!';
    setTimeout(() => btn.textContent = '📋 Copy Address', 1500);
  });
}

async function disconnectWallet() {
  try {
    if (connectedWallet === 'phantom') {
      const provider = getPhantomProvider();
      if (provider) await provider.disconnect();
    } else if (connectedWallet === 'solflare') {
      const provider = getSolflareProvider();
      if (provider) await provider.disconnect();
    }
  } catch (e) {}
  
  connectedWallet = null;
  walletPublicKey = null;
  walletBalance = null;
  portfolioTokens = [];
  
  const btn = document.getElementById('walletBtn');
  btn.innerHTML = '🔗 <span class="btn-label">Connect Wallet</span>';
  btn.classList.add('glow');
  btn.classList.remove('connected');
  
  closeWalletPanel();
}

function closeWalletPanel() { document.getElementById('walletPanel').classList.remove('active'); }

// =============================================
// PORTFOLIO
// =============================================
async function fetchPortfolio() {
  if (!walletPublicKey) return;
  portfolioTokens = [];
  
  try {
    const rpc = 'https://api.mainnet-beta.solana.com';
    // Fetch SPL token accounts
    const res = await fetch(rpc, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0', id: 1,
        method: 'getTokenAccountsByOwner',
        params: [
          walletPublicKey,
          { programId: 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' },
          { encoding: 'jsonParsed' }
        ]
      })
    });
    const data = await res.json();
    const accounts = data.result?.value || [];
    
    // Parse token accounts with non-zero balance
    portfolioTokens = accounts
      .map(acc => {
        const info = acc.account.data.parsed?.info;
        if (!info) return null;
        const amount = parseFloat(info.tokenAmount?.uiAmountString || '0');
        if (amount <= 0) return null;
        return {
          mint: info.mint,
          amount: amount,
          decimals: info.tokenAmount?.decimals || 0,
          name: null, symbol: null, image: null, price: 0, value: 0
        };
      })
      .filter(Boolean)
      .slice(0, 50); // Cap at 50 tokens

    // Enrich with token metadata from GeckoTerminal
    if (portfolioTokens.length > 0) {
      const mints = portfolioTokens.slice(0, 30).map(t => t.mint).join(',');
      try {
        const metaRes = await fetch(`${GT_BASE}/networks/solana/tokens/multi/${mints}?include=top_pools`);
        const metaJson = await metaRes.json();
        if (metaJson.data) {
          metaJson.data.forEach(td => {
            const addr = td.attributes?.address;
            const tok = portfolioTokens.find(t => t.mint === addr);
            if (tok && td.attributes) {
              tok.name = td.attributes.name;
              tok.symbol = td.attributes.symbol;
              tok.image = td.attributes.image_url;
              tok.price = parseFloat(td.attributes.price_usd) || 0;
              tok.value = tok.amount * tok.price;
            }
          });
        }
      } catch (e) {
        console.warn('Token metadata fetch partial fail:', e);
      }
    }
  } catch (err) {
    console.error('Portfolio fetch failed:', err);
  }
}

function openPortfolio() {
  const body = document.getElementById('portfolioPanelBody');
  
  if (!connectedWallet || !walletPublicKey) {
    body.innerHTML = `
      <div class="panel-empty">
        <div class="panel-empty-icon">👛</div>
        <div>Connect your wallet to view your portfolio</div>
        <button class="alert-add-btn" style="margin-top:16px;max-width:200px;margin-left:auto;margin-right:auto" onclick="closePortfolio();connectWallet()">Connect Wallet</button>
      </div>`;
    document.getElementById('portfolioPanel').classList.add('active');
    return;
  }

  // Show loading while fetching
  body.innerHTML = '<div class="portfolio-loading"><div class="spinner" style="margin:0 auto 12px"></div>Loading tokens...</div>';
  document.getElementById('portfolioPanel').classList.add('active');

  // Render after a short delay (data may already be fetched)
  setTimeout(renderPortfolio, portfolioTokens.length ? 100 : 2000);
}

function renderPortfolio() {
  const body = document.getElementById('portfolioPanelBody');
  
  // Add SOL to top
  const allTokens = [
    { mint: 'SOL', name: 'Solana', symbol: 'SOL', amount: walletBalance || 0, price: 0, value: 0, image: null, isSol: true }
  ];
  
  // Get SOL price from ticker
  const solTickerEl = document.getElementById('tk-sol');
  const solMatch = solTickerEl?.textContent?.match(/\$([0-9,.]+)/);
  if (solMatch) {
    allTokens[0].price = parseFloat(solMatch[1].replace(',', ''));
    allTokens[0].value = allTokens[0].amount * allTokens[0].price;
  }

  // Add SPL tokens sorted by value
  const enriched = portfolioTokens
    .filter(t => t.name || t.symbol)
    .sort((a, b) => b.value - a.value);
  allTokens.push(...enriched);

  // Unknown tokens (no metadata)
  const unknown = portfolioTokens.filter(t => !t.name && !t.symbol);

  const totalValue = allTokens.reduce((s, t) => s + (t.value || 0), 0);

  let html = `
    <div class="portfolio-total">
      <div>
        <div class="portfolio-total-label">TOTAL VALUE</div>
        <div class="portfolio-total-val">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
      </div>
      <button class="wallet-action-btn copy" style="flex:none;padding:8px 12px" onclick="fetchPortfolio();setTimeout(renderPortfolio,2000)">🔄 Refresh</button>
    </div>
  `;

  allTokens.forEach(t => {
    const g = gradients[Math.floor(Math.random() * gradients.length)];
    const icon = t.image
      ? `<img src="${t.image}" width="36" height="36" style="border-radius:50%" onerror="this.outerHTML='<div class=\\'portfolio-token-icon\\' style=\\'background:linear-gradient(135deg,${g[0]},${g[1]})\\'>${(t.symbol||'?')[0]}</div>'">`
      : `<div class="portfolio-token-icon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${t.isSol ? '◎' : (t.symbol || '?')[0]}</div>`;
    
    html += `
      <div class="portfolio-token">
        ${icon}
        <div class="portfolio-token-info">
          <div class="portfolio-token-name">${t.name || t.symbol || 'Unknown Token'}</div>
          <div class="portfolio-token-balance">${t.amount < 0.001 ? t.amount.toExponential(2) : t.amount.toLocaleString('en-US', { maximumFractionDigits: 4 })} ${t.symbol || ''}</div>
        </div>
        <div class="portfolio-token-val">
          <div class="portfolio-token-usd">${t.value > 0 ? '$' + t.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '—'}</div>
          ${t.price > 0 ? `<div class="portfolio-token-chg" style="color:var(--text-tertiary)">@$${t.price < 0.001 ? t.price.toExponential(2) : t.price.toFixed(4)}</div>` : ''}
        </div>
      </div>`;
  });

  if (unknown.length > 0) {
    html += `<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:.75rem">+ ${unknown.length} unverified tokens hidden</div>`;
  }

  if (allTokens.length <= 1 && !walletBalance) {
    html += '<div class="panel-empty"><div class="panel-empty-icon">📭</div>No tokens found in this wallet</div>';
  }

  body.innerHTML = html;
}

function closePortfolio() { document.getElementById('portfolioPanel').classList.remove('active'); }

// =============================================
// ALERTS SYSTEM
// =============================================
let alerts = JSON.parse(localStorage.getItem('radar_alerts') || '[]');

function saveAlerts() {
  localStorage.setItem('radar_alerts', JSON.stringify(alerts));
  updateAlertBadge();
}

function updateAlertBadge() {
  const count = alerts.length;
  const dot = document.getElementById('alertDot');
  const countEl = document.getElementById('alertCount');
  if (count > 0) {
    dot.style.display = 'inline-block';
    countEl.style.display = 'inline-block';
    countEl.textContent = count;
  } else {
    dot.style.display = 'none';
    countEl.style.display = 'none';
  }
}

function openAlerts() {
  // Populate token dropdown with current tokens
  const sel = document.getElementById('alertTokenSelect');
  sel.innerHTML = '<option value="">Select token...</option>';
  tokens.forEach((t, i) => {
    sel.innerHTML += `<option value="${i}">${t.tick} — ${t.name}</option>`;
  });
  renderAlertsList();
  document.getElementById('alertsPanel').classList.add('active');
}

function closeAlerts() { document.getElementById('alertsPanel').classList.remove('active'); }

function addAlert() {
  const tokenIdx = document.getElementById('alertTokenSelect').value;
  const condition = document.getElementById('alertCondition').value;
  const value = document.getElementById('alertValue').value;
  
  if (tokenIdx === '' || !value) return;
  
  const t = tokens[parseInt(tokenIdx)];
  if (!t) return;

  const condLabels = {
    above: `Price above $${value}`,
    below: `Price below $${value}`,
    change_up: `24h change above ${value}%`,
    change_down: `24h change below ${value}%`,
    volume: `Volume above $${value}`
  };

  alerts.push({
    id: Date.now(),
    tokenIdx: parseInt(tokenIdx),
    tick: t.tick,
    name: t.name,
    imageUrl: t.imageUrl,
    condition,
    value: parseFloat(value),
    condLabel: condLabels[condition],
    active: true,
    created: new Date().toISOString(),
    triggered: false,
  });

  saveAlerts();
  renderAlertsList();
  
  // Clear form
  document.getElementById('alertValue').value = '';
  document.getElementById('alertTokenSelect').value = '';
}

function removeAlert(id) {
  alerts = alerts.filter(a => a.id !== id);
  saveAlerts();
  renderAlertsList();
}

function toggleAlertActive(id) {
  const alert = alerts.find(a => a.id === id);
  if (alert) {
    alert.active = !alert.active;
    saveAlerts();
    renderAlertsList();
  }
}

function renderAlertsList() {
  const container = document.getElementById('alertsList');
  if (alerts.length === 0) {
    container.innerHTML = '<div class="panel-empty"><div class="panel-empty-icon">🔕</div>No alerts set yet<div style="font-size:.75rem;margin-top:8px">Create your first alert above, or toggle alerts on any token page</div></div>';
    return;
  }
  
  container.innerHTML = alerts.map(a => {
    const g = gradients[Math.floor(Math.random() * gradients.length)];
    const icon = a.imageUrl
      ? `<img src="${a.imageUrl}" width="36" height="36" style="border-radius:50%" onerror="this.style.display='none'">`
      : `<div class="alert-item-icon" style="background:linear-gradient(135deg,${g[0]},${g[1]})">${(a.tick || '?')[0]}</div>`;
    
    return `
      <div class="alert-item">
        ${icon}
        <div class="alert-item-info">
          <div class="alert-item-name">${a.tick} · ${a.name}</div>
          <div class="alert-item-cond">${a.condLabel}</div>
        </div>
        <span class="alert-item-active" style="${a.active ? '' : 'background:var(--bg-elevated);color:var(--text-muted)'}" onclick="toggleAlertActive(${a.id})">${a.active ? 'ACTIVE' : 'PAUSED'}</span>
        <button class="alert-item-remove" onclick="removeAlert(${a.id})">✕</button>
      </div>`;
  }).join('');
}

// Quick alert from token detail modal
function addQuickAlert(tokenIdx, condition, value) {
  const t = tokens[tokenIdx];
  if (!t) return;
  const condLabels = {
    above: `Price above $${value}`,
    below: `Price below $${value}`,
    change_up: `24h change above ${value}%`,
  };
  alerts.push({
    id: Date.now(),
    tokenIdx, tick: t.tick, name: t.name, imageUrl: t.imageUrl,
    condition, value: parseFloat(value),
    condLabel: condLabels[condition] || `${condition}: ${value}`,
    active: true, created: new Date().toISOString(), triggered: false,
  });
  saveAlerts();
}

// Check alerts against current data
function checkAlerts() {
  if (!alerts.length || !tokens.length) return;
  let triggered = [];
  
  alerts.forEach(a => {
    if (!a.active || a.triggered) return;
    // Find the token in current data by tick
    const t = tokens.find(tk => tk.tick === a.tick);
    if (!t) return;

    let hit = false;
    switch (a.condition) {
      case 'above': hit = t.p >= a.value; break;
      case 'below': hit = t.p <= a.value; break;
      case 'change_up': hit = t.h24 >= a.value; break;
      case 'change_down': hit = t.h24 <= a.value; break;
      case 'volume': hit = t.volRaw >= a.value; break;
    }
    
    if (hit) {
      a.triggered = true;
      triggered.push(a);
    }
  });

  // Show notification for triggered alerts
  if (triggered.length > 0) {
    saveAlerts();
    triggered.forEach(a => {
      showAlertNotification(a);
    });
  }
}

function showAlertNotification(alert) {
  // In-app notification
  const notif = document.createElement('div');
  notif.style.cssText = 'position:fixed;top:80px;right:20px;z-index:3000;background:var(--bg-primary);border:1px solid var(--accent);border-radius:var(--radius-lg);padding:16px 20px;box-shadow:0 12px 40px rgba(0,219,164,0.2);animation:panelSlide .3s ease;max-width:320px;cursor:pointer';
  notif.innerHTML = `
    <div style="font-weight:700;color:var(--accent);font-size:.8rem;margin-bottom:4px">🔔 Alert Triggered</div>
    <div style="font-weight:600;color:var(--text-primary);font-size:.9rem">${alert.tick} — ${alert.name}</div>
    <div style="font-size:.75rem;color:var(--text-tertiary);margin-top:2px">${alert.condLabel}</div>
  `;
  notif.onclick = () => { notif.remove(); openAlerts(); };
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 8000);

  // Browser notification if permitted
  if (Notification.permission === 'granted') {
    new Notification(`RADAR Alert: ${alert.tick}`, { body: alert.condLabel, icon: alert.imageUrl || '' });
  } else if (Notification.permission !== 'denied') {
    Notification.requestPermission();
  }
}

// Init alerts
updateAlertBadge();

// Check alerts every 30s (when data refreshes)
setInterval(checkAlerts, 30000);

// =============================================
// ADD ALERT TOGGLE TO TOKEN MODAL
// =============================================
// Patch openModal to include alert toggle at bottom of AI box
const _origOpenModal = openModal;
openModal = function(i) {
  _origOpenModal(i);
  const t = tokens[i];
  if (!t) return;
  
  // Add alert quick-add row below the AI box
  const aiBox = document.querySelector('.ai-box');
  if (aiBox) {
    const existing = alerts.find(a => a.tick === t.tick && a.active);
    aiBox.insertAdjacentHTML('afterend', `
      <div class="alert-toggle-row" onclick="toggleModalAlert(${i}, this)" style="margin-top:12px">
        <span class="alert-toggle-label">🔔 Price Alert for ${t.tick}</span>
        <div class="alert-toggle ${existing ? 'on' : ''}" id="modalAlertToggle"></div>
      </div>
      <div id="modalAlertConfig" style="display:${existing ? 'none' : 'none'};margin-top:8px">
        <div class="alert-form" style="margin-bottom:0">
          <div class="alert-form-row">
            <select id="modalAlertCond">
              <option value="above">Price goes above</option>
              <option value="below">Price goes below</option>
              <option value="change_up">24h change above %</option>
            </select>
          </div>
          <div class="alert-form-row">
            <input type="text" id="modalAlertVal" placeholder="${t.p > 0.001 ? 'e.g. ' + (t.p * 1.5).toFixed(6) : 'Enter target price...'}" />
          </div>
          <button class="alert-add-btn" onclick="saveModalAlert(${i})">Set Alert</button>
        </div>
      </div>
    `);
  }
};

function toggleModalAlert(idx, row) {
  const toggle = document.getElementById('modalAlertToggle');
  const config = document.getElementById('modalAlertConfig');
  const t = tokens[idx];
  
  if (toggle.classList.contains('on')) {
    // Remove alert for this token
    alerts = alerts.filter(a => a.tick !== t.tick);
    saveAlerts();
    toggle.classList.remove('on');
    config.style.display = 'none';
  } else {
    // Show config to set alert
    config.style.display = 'block';
    toggle.classList.add('on');
  }
}

function saveModalAlert(idx) {
  const cond = document.getElementById('modalAlertCond').value;
  const val = document.getElementById('modalAlertVal').value;
  if (!val) return;
  
  addQuickAlert(idx, cond, val);
  
  // Visual feedback
  const config = document.getElementById('modalAlertConfig');
  config.innerHTML = '<div style="text-align:center;padding:12px;color:var(--accent);font-weight:600">✓ Alert Set!</div>';
  setTimeout(() => { config.style.display = 'none'; }, 1500);
  
  updateAlertBadge();
}

// =============================================
// INIT & AUTO-REFRESH
// =============================================
render(); // show loading state
loadData('trending');
fetchTickerPrices();

// Auto-refresh: tokens every 30s, ticker every 60s, feed every 12s
setInterval(async () => {
  // Fetch fresh data regardless of current view
  const apiView = activeView === 'losers' ? 'gainers' : activeView === 'launchpad' ? 'new' : 'trending';
  const isAll = currentNetwork === 'all';
  let result;
  if (apiView === 'new') result = isAll ? await fetchAllChainsNew() : await fetchNewPools();
  else if (apiView === 'gainers') result = isAll ? await fetchAllChainsTop() : await fetchTopPools();
  else result = isAll ? await fetchAllChainsTrending() : await fetchTrending();
  if (result && result.length) {
    tokens = result;
    rankTokens(tokens);
    isLoading = false;
    // Re-render based on active view
    const c = contentEl();
    if (['trending','new','gainers','losers','launchpad'].includes(activeView)) { render(); }
    else if (activeView === 'whales' && c) renderWhaleView(c);
    else if (activeView === 'scanner' && c) renderScannerView(c);
    renderHeat(); renderDynamicFeed(); renderWallets();
  }
}, 30000);
setInterval(fetchTickerPrices, 60000);
setInterval(renderDynamicFeed, 12000);
</script>
</body>
</html>
